{"version":3,"file":"floating-link-editor-plugin.jsx","sourceRoot":"","sources":["floating-link-editor-plugin.tsx"],"names":[],"mappings":"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","sourcesContent":["'use client'\n\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\nimport { Dispatch, useCallback, useEffect, useRef, useState, JSX } from 'react'\nimport * as React from 'react'\n\nimport {\n  $createLinkNode,\n  $isAutoLinkNode,\n  $isLinkNode,\n  TOGGLE_LINK_COMMAND,\n} from '@lexical/link'\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\nimport { $findMatchingParent, mergeRegister } from '@lexical/utils'\nimport {\n  $getSelection,\n  $isLineBreakNode,\n  $isRangeSelection,\n  BaseSelection,\n  CLICK_COMMAND,\n  COMMAND_PRIORITY_CRITICAL,\n  COMMAND_PRIORITY_HIGH,\n  COMMAND_PRIORITY_LOW,\n  KEY_ESCAPE_COMMAND,\n  LexicalEditor,\n  SELECTION_CHANGE_COMMAND,\n} from 'lexical'\nimport { Check, Pencil, Trash, X } from 'lucide-react'\nimport { createPortal } from 'react-dom'\n\nimport { Button } from '../../ui/button'\nimport { Input } from '../../ui/input'\n\nimport { useFloatingLinkContext } from '../context/floating-link-context'\nimport { getSelectedNode } from '../utils/get-selected-node'\nimport { setFloatingElemPositionForLinkEditor } from '../utils/set-floating-elem-position-for-link-editor'\nimport { sanitizeUrl } from '../utils/url'\n\nfunction FloatingLinkEditor({\n  editor,\n  isLink,\n  setIsLink,\n  anchorElem,\n  isLinkEditMode,\n  setIsLinkEditMode,\n}: {\n  editor: LexicalEditor\n  isLink: boolean\n  setIsLink: Dispatch<boolean>\n  anchorElem: HTMLElement\n  isLinkEditMode: boolean\n  setIsLinkEditMode: Dispatch<boolean>\n}): JSX.Element {\n  const editorRef = useRef<HTMLDivElement | null>(null)\n  const inputRef = useRef<HTMLInputElement>(null)\n  const [linkUrl, setLinkUrl] = useState('')\n  const [editedLinkUrl, setEditedLinkUrl] = useState('https://')\n  const [lastSelection, setLastSelection] = useState<BaseSelection | null>(null)\n\n  const $updateLinkEditor = useCallback(() => {\n    const selection = $getSelection()\n    if ($isRangeSelection(selection)) {\n      const node = getSelectedNode(selection)\n      const linkParent = $findMatchingParent(node, $isLinkNode)\n\n      if (linkParent) {\n        setLinkUrl(linkParent.getURL())\n      } else if ($isLinkNode(node)) {\n        setLinkUrl(node.getURL())\n      } else {\n        setLinkUrl('')\n      }\n      if (isLinkEditMode) {\n        setEditedLinkUrl(linkUrl)\n      }\n    }\n    const editorElem = editorRef.current\n    const nativeSelection = window.getSelection()\n    const activeElement = document.activeElement\n\n    if (editorElem === null) {\n      return\n    }\n\n    const rootElement = editor.getRootElement()\n\n    if (\n      selection !== null &&\n      nativeSelection !== null &&\n      rootElement !== null &&\n      rootElement.contains(nativeSelection.anchorNode) &&\n      editor.isEditable()\n    ) {\n      const domRect: DOMRect | undefined =\n        nativeSelection.focusNode?.parentElement?.getBoundingClientRect()\n      if (domRect) {\n        domRect.y += 40\n        setFloatingElemPositionForLinkEditor(domRect, editorElem, anchorElem)\n      }\n      setLastSelection(selection)\n    } else if (!activeElement || activeElement.className !== 'link-input') {\n      if (rootElement !== null) {\n        setFloatingElemPositionForLinkEditor(null, editorElem, anchorElem)\n      }\n      setLastSelection(null)\n      setIsLinkEditMode(false)\n      setLinkUrl('')\n    }\n\n    return true\n  }, [anchorElem, editor, setIsLinkEditMode, isLinkEditMode, linkUrl])\n\n  useEffect(() => {\n    const scrollerElem = anchorElem.parentElement\n\n    const update = () => {\n      editor.getEditorState().read(() => {\n        $updateLinkEditor()\n      })\n    }\n\n    window.addEventListener('resize', update)\n\n    if (scrollerElem) {\n      scrollerElem.addEventListener('scroll', update)\n    }\n\n    return () => {\n      window.removeEventListener('resize', update)\n\n      if (scrollerElem) {\n        scrollerElem.removeEventListener('scroll', update)\n      }\n    }\n  }, [anchorElem.parentElement, editor, $updateLinkEditor])\n\n  useEffect(() => {\n    return mergeRegister(\n      editor.registerUpdateListener(({ editorState }) => {\n        editorState.read(() => {\n          $updateLinkEditor()\n        })\n      }),\n\n      editor.registerCommand(\n        SELECTION_CHANGE_COMMAND,\n        () => {\n          $updateLinkEditor()\n          return true\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ESCAPE_COMMAND,\n        () => {\n          if (isLink) {\n            setIsLink(false)\n            return true\n          }\n          return false\n        },\n        COMMAND_PRIORITY_HIGH\n      )\n    )\n  }, [editor, $updateLinkEditor, setIsLink, isLink])\n\n  useEffect(() => {\n    editor.getEditorState().read(() => {\n      $updateLinkEditor()\n    })\n  }, [editor, $updateLinkEditor])\n\n  useEffect(() => {\n    if (isLinkEditMode && inputRef.current) {\n      inputRef.current.focus()\n      setIsLink(true)\n    }\n  }, [isLinkEditMode, isLink])\n\n  const monitorInputInteraction = (\n    event: React.KeyboardEvent<HTMLInputElement>\n  ) => {\n    if (event.key === 'Enter') {\n      event.preventDefault()\n      handleLinkSubmission()\n    } else if (event.key === 'Escape') {\n      event.preventDefault()\n      setIsLinkEditMode(false)\n    }\n  }\n\n  const handleLinkSubmission = () => {\n    if (lastSelection !== null) {\n      if (linkUrl !== '') {\n        editor.dispatchCommand(TOGGLE_LINK_COMMAND, sanitizeUrl(editedLinkUrl))\n        editor.update(() => {\n          const selection = $getSelection()\n          if ($isRangeSelection(selection)) {\n            const parent = getSelectedNode(selection).getParent()\n            if ($isAutoLinkNode(parent)) {\n              const linkNode = $createLinkNode(parent.getURL(), {\n                rel: parent.__rel,\n                target: parent.__target,\n                title: parent.__title,\n              })\n              parent.replace(linkNode, true)\n            }\n          }\n        })\n      }\n      setEditedLinkUrl('https://')\n      setIsLinkEditMode(false)\n    }\n  }\n  return (\n    <div\n      ref={editorRef}\n      className=\"absolute left-0 top-0 w-full max-w-sm rounded-md opacity-0 shadow-md\"\n    >\n      {!isLink ? null : isLinkEditMode ? (\n        <div className=\"flex items-center space-x-2 rounded-md border p-1 pl-2\">\n          <Input\n            ref={inputRef}\n            value={editedLinkUrl}\n            onChange={(event) => setEditedLinkUrl(event.target.value)}\n            onKeyDown={monitorInputInteraction}\n            className=\"flex-grow\"\n          />\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={() => {\n              setIsLinkEditMode(false)\n              setIsLink(false)\n            }}\n            className=\"shrink-0\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            size=\"icon\"\n            onClick={handleLinkSubmission}\n            className=\"shrink-0\"\n          >\n            <Check className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      ) : (\n        <div className=\"flex items-center justify-between rounded-md border p-1 pl-2\">\n          <a\n            href={sanitizeUrl(linkUrl)}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"overflow-hidden text-ellipsis whitespace-nowrap text-sm\"\n          >\n            {linkUrl}\n          </a>\n          <div className=\"flex\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={() => {\n                setEditedLinkUrl(linkUrl)\n                setIsLinkEditMode(true)\n              }}\n            >\n              <Pencil className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              size=\"icon\"\n              variant=\"destructive\"\n              onClick={() => {\n                editor.dispatchCommand(TOGGLE_LINK_COMMAND, null)\n              }}\n            >\n              <Trash className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\nfunction useFloatingLinkEditorToolbar(\n  editor: LexicalEditor,\n  anchorElem: HTMLDivElement | null,\n  isLinkEditMode: boolean,\n  setIsLinkEditMode: Dispatch<boolean>\n): JSX.Element | null {\n  const [activeEditor, setActiveEditor] = useState(editor)\n  const [isLink, setIsLink] = useState(false)\n\n  useEffect(() => {\n    function $updateToolbar() {\n      const selection = $getSelection()\n      if ($isRangeSelection(selection)) {\n        const focusNode = getSelectedNode(selection)\n        const focusLinkNode = $findMatchingParent(focusNode, $isLinkNode)\n        const focusAutoLinkNode = $findMatchingParent(\n          focusNode,\n          $isAutoLinkNode\n        )\n        if (!(focusLinkNode || focusAutoLinkNode)) {\n          setIsLink(false)\n          return\n        }\n        const badNode = selection\n          .getNodes()\n          .filter((node) => !$isLineBreakNode(node))\n          .find((node) => {\n            const linkNode = $findMatchingParent(node, $isLinkNode)\n            const autoLinkNode = $findMatchingParent(node, $isAutoLinkNode)\n            return (\n              (focusLinkNode && !focusLinkNode.is(linkNode)) ||\n              (linkNode && !linkNode.is(focusLinkNode)) ||\n              (focusAutoLinkNode && !focusAutoLinkNode.is(autoLinkNode)) ||\n              (autoLinkNode &&\n                (!autoLinkNode.is(focusAutoLinkNode) ||\n                  autoLinkNode.getIsUnlinked()))\n            )\n          })\n\n        if (!badNode) {\n          setIsLink(true)\n        } else {\n          setIsLink(false)\n        }\n      }\n    }\n    return mergeRegister(\n      editor.registerUpdateListener(({ editorState }) => {\n        editorState.read(() => {\n          $updateToolbar()\n        })\n      }),\n      editor.registerCommand(\n        SELECTION_CHANGE_COMMAND,\n        (_payload, newEditor) => {\n          $updateToolbar()\n          setActiveEditor(newEditor)\n          return false\n        },\n        COMMAND_PRIORITY_CRITICAL\n      ),\n      editor.registerCommand(\n        CLICK_COMMAND,\n        (payload) => {\n          const selection = $getSelection()\n          if ($isRangeSelection(selection)) {\n            const node = getSelectedNode(selection)\n            const linkNode = $findMatchingParent(node, $isLinkNode)\n            if ($isLinkNode(linkNode) && (payload.metaKey || payload.ctrlKey)) {\n              window.open(linkNode.getURL(), '_blank')\n              return true\n            }\n          }\n          return false\n        },\n        COMMAND_PRIORITY_LOW\n      )\n    )\n  }, [editor])\n\n  if (!anchorElem) {\n    return null\n  }\n\n  return createPortal(\n    <FloatingLinkEditor\n      editor={activeEditor}\n      isLink={isLink}\n      anchorElem={anchorElem}\n      setIsLink={setIsLink}\n      isLinkEditMode={isLinkEditMode}\n      setIsLinkEditMode={setIsLinkEditMode}\n    />,\n    anchorElem\n  )\n}\n\nexport function FloatingLinkEditorPlugin({\n  anchorElem,\n}: {\n  anchorElem: HTMLDivElement | null\n}): JSX.Element | null {\n  const [editor] = useLexicalComposerContext()\n  const { isLinkEditMode, setIsLinkEditMode } = useFloatingLinkContext()\n\n  return useFloatingLinkEditorToolbar(\n    editor,\n    anchorElem,\n    isLinkEditMode,\n    setIsLinkEditMode\n  )\n}\n"]}