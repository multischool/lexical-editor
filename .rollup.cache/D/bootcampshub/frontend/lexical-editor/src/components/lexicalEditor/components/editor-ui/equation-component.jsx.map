{"version":3,"file":"equation-component.jsx","sourceRoot":"","sources":["equation-component.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react'\nimport { useCallback, useEffect, useRef, useState, JSX } from 'react'\n\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\nimport { useLexicalEditable } from '@lexical/react/useLexicalEditable'\nimport { mergeRegister } from '@lexical/utils'\nimport {\n  $getNodeByKey,\n  $getSelection,\n  $isNodeSelection,\n  COMMAND_PRIORITY_HIGH,\n  KEY_ESCAPE_COMMAND,\n  NodeKey,\n  SELECTION_CHANGE_COMMAND,\n} from 'lexical'\nimport { ErrorBoundary } from 'react-error-boundary'\n\nimport { $isEquationNode } from '../nodes/equation-node'\nimport EquationEditor from '../editor-ui/equation-editor'\nimport KatexRenderer from '../editor-ui/katex-renderer'\n\ntype EquationComponentProps = {\n  equation: string\n  inline: boolean\n  nodeKey: NodeKey\n}\n\nexport default function EquationComponent({\n  equation,\n  inline,\n  nodeKey,\n}: EquationComponentProps): JSX.Element {\n  const [editor] = useLexicalComposerContext()\n  const isEditable = useLexicalEditable()\n  const [equationValue, setEquationValue] = useState(equation)\n  const [showEquationEditor, setShowEquationEditor] = useState<boolean>(false)\n  const inputRef = useRef(null)\n\n  const onHide = useCallback(\n    (restoreSelection?: boolean) => {\n      setShowEquationEditor(false)\n      editor.update(() => {\n        const node = $getNodeByKey(nodeKey)\n        if ($isEquationNode(node)) {\n          node.setEquation(equationValue)\n          if (restoreSelection) {\n            node.selectNext(0, 0)\n          }\n        }\n      })\n    },\n    [editor, equationValue, nodeKey]\n  )\n\n  useEffect(() => {\n    if (!showEquationEditor && equationValue !== equation) {\n      setEquationValue(equation)\n    }\n  }, [showEquationEditor, equation, equationValue])\n\n  useEffect(() => {\n    if (!isEditable) {\n      return\n    }\n    if (showEquationEditor) {\n      return mergeRegister(\n        editor.registerCommand(\n          SELECTION_CHANGE_COMMAND,\n          (payload) => {\n            const activeElement = document.activeElement\n            const inputElem = inputRef.current\n            if (inputElem !== activeElement) {\n              onHide()\n            }\n            return false\n          },\n          COMMAND_PRIORITY_HIGH\n        ),\n        editor.registerCommand(\n          KEY_ESCAPE_COMMAND,\n          (payload) => {\n            const activeElement = document.activeElement\n            const inputElem = inputRef.current\n            if (inputElem === activeElement) {\n              onHide(true)\n              return true\n            }\n            return false\n          },\n          COMMAND_PRIORITY_HIGH\n        )\n      )\n    } else {\n      return editor.registerUpdateListener(({ editorState }) => {\n        const isSelected = editorState.read(() => {\n          const selection = $getSelection()\n          return (\n            $isNodeSelection(selection) &&\n            selection.has(nodeKey) &&\n            selection.getNodes().length === 1\n          )\n        })\n        if (isSelected) {\n          setShowEquationEditor(true)\n        }\n      })\n    }\n  }, [editor, nodeKey, onHide, showEquationEditor, isEditable])\n\n  return (\n    <>\n      {showEquationEditor && isEditable ? (\n        <EquationEditor\n          equation={equationValue}\n          setEquation={setEquationValue}\n          inline={inline}\n          ref={inputRef}\n        />\n      ) : (\n        <ErrorBoundary onError={(e) => editor._onError(e)} fallback={null}>\n          <KatexRenderer\n            equation={equationValue}\n            inline={inline}\n            onDoubleClick={() => {\n              if (isEditable) {\n                setShowEquationEditor(true)\n              }\n            }}\n          />\n        </ErrorBoundary>\n      )}\n    </>\n  )\n}\n"]}