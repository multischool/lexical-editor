{"version":3,"file":"code-action-menu-plugin.jsx","sourceRoot":"","sources":["code-action-menu-plugin.tsx"],"names":[],"mappings":"AAAA,YAAY,CAAA;AAEZ;;;;;;GAMG;AACH,wBAAwB;AACxB,OAAO,EAAE,SAAS,EAAE,MAAM,EAAE,QAAQ,EAAO,MAAM,OAAO,CAAA;AACxD,OAAO,KAAK,KAAK,MAAM,OAAO,CAAA;AAE9B,OAAO,EACL,WAAW,EACX,QAAQ,EACR,uBAAuB,EACvB,iBAAiB,GAClB,MAAM,eAAe,CAAA;AACtB,OAAO,EAAE,yBAAyB,EAAE,MAAM,uCAAuC,CAAA;AACjF,OAAO,EAAE,0BAA0B,EAAE,MAAM,SAAS,CAAA;AACpD,OAAO,EAAE,YAAY,EAAE,MAAM,WAAW,CAAA;AAExC,OAAO,EAAE,WAAW,EAAE,MAAM,8BAA8B,CAAA;AAC1D,OAAO,EAAE,UAAU,EAAE,MAAM,0BAA0B,CAAA;AAErD,MAAM,YAAY,GAAG,CAAC,CAAA;AAOtB,SAAS,uBAAuB,CAAC,EAC/B,UAAU,GAGX;IACC,MAAM,CAAC,MAAM,CAAC,GAAG,yBAAyB,EAAE,CAAA;IAE5C,MAAM,CAAC,IAAI,EAAE,OAAO,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAA;IACpC,MAAM,CAAC,OAAO,EAAE,QAAQ,CAAC,GAAG,QAAQ,CAAU,KAAK,CAAC,CAAA;IACpD,MAAM,CAAC,qBAAqB,EAAE,wBAAwB,CAAC,GACrD,QAAQ,CAAU,KAAK,CAAC,CAAA;IAC1B,MAAM,CAAC,QAAQ,EAAE,WAAW,CAAC,GAAG,QAAQ,CAAW;QACjD,KAAK,EAAE,GAAG;QACV,GAAG,EAAE,GAAG;KACT,CAAC,CAAA;IACF,MAAM,UAAU,GAAG,MAAM,CAAc,IAAI,GAAG,EAAE,CAAC,CAAA;IACjD,MAAM,cAAc,GAAG,MAAM,CAAqB,IAAI,CAAC,CAAA;IAEvD,SAAS,cAAc;QACrB,OAAO,cAAc,CAAC,OAAO,CAAA;IAC/B,CAAC;IAED,MAAM,oBAAoB,GAAG,WAAW,CACtC,CAAC,KAAiB,EAAE,EAAE;QACpB,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,GAAG,YAAY,CAAC,KAAK,CAAC,CAAA;QACtD,IAAI,SAAS,EAAE,CAAC;YACd,QAAQ,CAAC,KAAK,CAAC,CAAA;YACf,OAAM;QACR,CAAC;QAED,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAM;QACR,CAAC;QAED,cAAc,CAAC,OAAO,GAAG,WAAW,CAAA;QAEpC,IAAI,QAAQ,GAAoB,IAAI,CAAA;QACpC,IAAI,KAAK,GAAG,EAAE,CAAA;QAEd,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE;YACjB,MAAM,aAAa,GAAG,0BAA0B,CAAC,WAAW,CAAC,CAAA;YAE7D,IAAI,WAAW,CAAC,aAAa,CAAC,EAAE,CAAC;gBAC/B,QAAQ,GAAG,aAAa,CAAA;gBACxB,KAAK,GAAG,QAAQ,CAAC,WAAW,EAAE,IAAI,EAAE,CAAA;YACtC,CAAC;QACH,CAAC,CAAC,CAAA;QAEF,IAAI,QAAQ,EAAE,CAAC;YACb,MAAM,EAAE,CAAC,EAAE,WAAW,EAAE,KAAK,EAAE,eAAe,EAAE,GAC9C,UAAU,CAAC,qBAAqB,EAAE,CAAA;YACpC,MAAM,EAAE,CAAC,EAAE,KAAK,EAAE,GAAG,WAAW,CAAC,qBAAqB,EAAE,CAAA;YACxD,OAAO,CAAC,KAAK,CAAC,CAAA;YACd,QAAQ,CAAC,IAAI,CAAC,CAAA;YACd,WAAW,CAAC;gBACV,KAAK,EAAE,GAAG,eAAe,GAAG,KAAK,GAAG,YAAY,IAAI;gBACpD,GAAG,EAAE,GAAG,CAAC,GAAG,WAAW,IAAI;aAC5B,CAAC,CAAA;QACJ,CAAC;IACH,CAAC,EACD,EAAE,EACF,IAAI,CACL,CAAA;IAED,SAAS,CAAC,GAAG,EAAE;QACb,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC3B,OAAM;QACR,CAAC;QAED,QAAQ,CAAC,gBAAgB,CAAC,WAAW,EAAE,oBAAoB,CAAC,CAAA;QAE5D,OAAO,GAAG,EAAE;YACV,QAAQ,CAAC,KAAK,CAAC,CAAA;YACf,oBAAoB,CAAC,MAAM,EAAE,CAAA;YAC7B,QAAQ,CAAC,mBAAmB,CAAC,WAAW,EAAE,oBAAoB,CAAC,CAAA;QACjE,CAAC,CAAA;IACH,CAAC,EAAE,CAAC,qBAAqB,EAAE,oBAAoB,CAAC,CAAC,CAAA;IAEjD,SAAS,CAAC,GAAG,EAAE;QACb,OAAO,MAAM,CAAC,wBAAwB,CACpC,QAAQ,EACR,CAAC,SAAS,EAAE,EAAE;YACZ,MAAM,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE;gBAChC,KAAK,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,IAAI,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC;oBAChD,QAAQ,IAAI,EAAE,CAAC;wBACb,KAAK,SAAS;4BACZ,UAAU,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;4BAC3B,MAAK;wBAEP,KAAK,WAAW;4BACd,UAAU,CAAC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;4BAC9B,MAAK;wBAEP;4BACE,MAAK;oBACT,CAAC;gBACH,CAAC;YACH,CAAC,CAAC,CAAA;YACF,wBAAwB,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,GAAG,CAAC,CAAC,CAAA;QACvD,CAAC,EACD,EAAE,kBAAkB,EAAE,KAAK,EAAE,CAC9B,CAAA;IACH,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAAA;IAEZ,MAAM,cAAc,GAAG,iBAAiB,CAAC,IAAI,CAAC,CAAA;IAC9C,MAAM,gBAAgB,GAAG,uBAAuB,CAAC,IAAI,CAAC,CAAA;IAEtD,OAAO,CACL,EACE;MAAA,CAAC,OAAO,CAAC,CAAC,CAAC,CACT,CAAC,GAAG,CACF,SAAS,CAAC,0HAA0H,CACpI,KAAK,CAAC,CAAC,kBAAK,QAAQ,EAAG,CAEvB;UAAA,CAAC,GAAG,CAAC,CAAC,gBAAgB,CAAC,EAAE,GAAG,CAC5B;UAAA,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,CAAC,cAAc,CAAC,CAAC,cAAc,CAAC,EAC7D;QAAA,EAAE,GAAG,CAAC,CACP,CAAC,CAAC,CAAC,IAAI,CACV;IAAA,GAAG,CACJ,CAAA;AACH,CAAC;AAED,SAAS,YAAY,CAAC,KAAiB;IAIrC,MAAM,MAAM,GAAG,KAAK,CAAC,MAAM,CAAA;IAE3B,IAAI,MAAM,IAAI,MAAM,YAAY,WAAW,EAAE,CAAC;QAC5C,MAAM,WAAW,GAAG,MAAM,CAAC,OAAO,CAAc,wBAAwB,CAAC,CAAA;QACzE,MAAM,SAAS,GAAG,CAAC,CACjB,WAAW;YACX,MAAM,CAAC,OAAO,CAAc,gCAAgC,CAAC,CAC9D,CAAA;QAED,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,CAAA;IACnC,CAAC;SAAM,CAAC;QACN,OAAO,EAAE,WAAW,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE,CAAA;IAC/C,CAAC;AACH,CAAC;AAED,MAAM,UAAU,oBAAoB,CAAC,EACnC,UAAU,GAGX;IACC,IAAI,CAAC,UAAU,EAAE,CAAC;QAChB,OAAO,IAAI,CAAA;IACb,CAAC;IAED,OAAO,YAAY,CACjB,CAAC,uBAAuB,CAAC,UAAU,CAAC,CAAC,UAAU,CAAC,EAAG,EACnD,UAAU,CACX,CAAA;AACH,CAAC","sourcesContent":["'use client'\n\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n// import './index.css';\nimport { useEffect, useRef, useState, JSX } from 'react'\nimport * as React from 'react'\n\nimport {\n  $isCodeNode,\n  CodeNode,\n  getLanguageFriendlyName,\n  normalizeCodeLang,\n} from '@lexical/code'\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\nimport { $getNearestNodeFromDOMNode } from 'lexical'\nimport { createPortal } from 'react-dom'\n\nimport { useDebounce } from '../editor-hooks/use-debounce'\nimport { CopyButton } from '../editor-ui/code-button'\n\nconst CODE_PADDING = 8\n\ninterface Position {\n  top: string\n  right: string\n}\n\nfunction CodeActionMenuContainer({\n  anchorElem,\n}: {\n  anchorElem: HTMLElement\n}): JSX.Element {\n  const [editor] = useLexicalComposerContext()\n\n  const [lang, setLang] = useState('')\n  const [isShown, setShown] = useState<boolean>(false)\n  const [shouldListenMouseMove, setShouldListenMouseMove] =\n    useState<boolean>(false)\n  const [position, setPosition] = useState<Position>({\n    right: '0',\n    top: '0',\n  })\n  const codeSetRef = useRef<Set<string>>(new Set())\n  const codeDOMNodeRef = useRef<HTMLElement | null>(null)\n\n  function getCodeDOMNode(): HTMLElement | null {\n    return codeDOMNodeRef.current\n  }\n\n  const debouncedOnMouseMove = useDebounce(\n    (event: MouseEvent) => {\n      const { codeDOMNode, isOutside } = getMouseInfo(event)\n      if (isOutside) {\n        setShown(false)\n        return\n      }\n\n      if (!codeDOMNode) {\n        return\n      }\n\n      codeDOMNodeRef.current = codeDOMNode\n\n      let codeNode: CodeNode | null = null\n      let _lang = ''\n\n      editor.update(() => {\n        const maybeCodeNode = $getNearestNodeFromDOMNode(codeDOMNode)\n\n        if ($isCodeNode(maybeCodeNode)) {\n          codeNode = maybeCodeNode\n          _lang = codeNode.getLanguage() || ''\n        }\n      })\n\n      if (codeNode) {\n        const { y: editorElemY, right: editorElemRight } =\n          anchorElem.getBoundingClientRect()\n        const { y, right } = codeDOMNode.getBoundingClientRect()\n        setLang(_lang)\n        setShown(true)\n        setPosition({\n          right: `${editorElemRight - right + CODE_PADDING}px`,\n          top: `${y - editorElemY}px`,\n        })\n      }\n    },\n    50,\n    1000\n  )\n\n  useEffect(() => {\n    if (!shouldListenMouseMove) {\n      return\n    }\n\n    document.addEventListener('mousemove', debouncedOnMouseMove)\n\n    return () => {\n      setShown(false)\n      debouncedOnMouseMove.cancel()\n      document.removeEventListener('mousemove', debouncedOnMouseMove)\n    }\n  }, [shouldListenMouseMove, debouncedOnMouseMove])\n\n  useEffect(() => {\n    return editor.registerMutationListener(\n      CodeNode,\n      (mutations) => {\n        editor.getEditorState().read(() => {\n          for (const [key, type] of Array.from(mutations)) {\n            switch (type) {\n              case 'created':\n                codeSetRef.current.add(key)\n                break\n\n              case 'destroyed':\n                codeSetRef.current.delete(key)\n                break\n\n              default:\n                break\n            }\n          }\n        })\n        setShouldListenMouseMove(codeSetRef.current.size > 0)\n      },\n      { skipInitialization: false }\n    )\n  }, [editor])\n\n  const normalizedLang = normalizeCodeLang(lang)\n  const codeFriendlyName = getLanguageFriendlyName(lang)\n\n  return (\n    <>\n      {isShown ? (\n        <div\n          className=\"code-action-menu-container user-select-none absolute flex h-9 flex-row items-center space-x-1 text-xs text-foreground/50\"\n          style={{ ...position }}\n        >\n          <div>{codeFriendlyName}</div>\n          <CopyButton editor={editor} getCodeDOMNode={getCodeDOMNode} />\n        </div>\n      ) : null}\n    </>\n  )\n}\n\nfunction getMouseInfo(event: MouseEvent): {\n  codeDOMNode: HTMLElement | null\n  isOutside: boolean\n} {\n  const target = event.target\n\n  if (target && target instanceof HTMLElement) {\n    const codeDOMNode = target.closest<HTMLElement>('code.EditorTheme__code')\n    const isOutside = !(\n      codeDOMNode ||\n      target.closest<HTMLElement>('div.code-action-menu-container')\n    )\n\n    return { codeDOMNode, isOutside }\n  } else {\n    return { codeDOMNode: null, isOutside: true }\n  }\n}\n\nexport function CodeActionMenuPlugin({\n  anchorElem,\n}: {\n  anchorElem: HTMLDivElement | null\n}): React.ReactPortal | null {\n  if (!anchorElem) {\n    return null\n  }\n\n  return createPortal(\n    <CodeActionMenuContainer anchorElem={anchorElem} />,\n    anchorElem\n  )\n}\n"]}