const e=(e,t)=>e.unstable_is?e.unstable_is(t):t===e,t=e=>"init"in e,n=e=>!!e.write,o=new WeakMap,r=e=>{var t;return i(e)&&!(null==(t=o.get(e))?void 0:t[1])},i=e=>"function"==typeof(null==e?void 0:e.then),s=e=>"v"in e||"e"in e,l=e=>{if("e"in e)throw e.e;if("production"!==(import.meta.env?import.meta.env.MODE:void 0)&&!("v"in e))throw new Error("[Bug] atom state is not initialized");return e.v},a=(e,t,n)=>{n.p.has(e)||(n.p.add(e),t.then((()=>{n.p.delete(e)}),(()=>{n.p.delete(e)})))},d=(e,t,n,o,i)=>{var s;if("production"!==(import.meta.env?import.meta.env.MODE:void 0)&&o===t)throw new Error("[Bug] atom cannot depend on itself");n.d.set(o,i.n),r(n.v)&&a(t,n.v,i),null==(s=i.m)||s.t.add(t),e&&m(e,o,t)},c=()=>({D:new Map,H:new Set,M:new Set,L:new Set}),f=(e,t,n)=>{e[t].add(n)},u=(e,t,n)=>{e.D.has(t)||(e.D.set(t,new Set),f(e,"M",(()=>{var t;null==(t=n.m)||t.l.forEach((t=>f(e,"M",t)))})))},m=(e,t,n)=>{const o=e.D.get(t);o&&o.add(n)},v=e=>{let t,n=!1;const o=e=>{try{e()}catch(e){n||(t=e,n=!0)}};for(;e.H.size||e.M.size||e.L.size;)e.D.clear(),e.H.forEach(o),e.H.clear(),e.M.forEach(o),e.M.clear(),e.L.forEach(o),e.L.clear();if(n)throw t},p=(...[m,w,h,y])=>{const _=(e,t,n)=>{const s="v"in t,l=t.v,d=r(t.v)?t.v:null;if(i(n)){(e=>{if(o.has(e))return;const t=[new Set,!1];o.set(e,t);const n=()=>{t[1]=!0};e.then(n,n),e.onCancel=e=>{t[0].add(e)}})(n);for(const o of t.d.keys())a(e,n,m(o));t.v=n}else t.v=n;delete t.e,delete t.x,s&&Object.is(l,t.v)||(++t.n,d&&((e,t)=>{const n=o.get(e);if(n)n[1]=!0,n[0].forEach((e=>e(t)));else if("production"!==(import.meta.env?import.meta.env.MODE:void 0))throw new Error("[Bug] cancelable promise not found")})(d,n))},E=(o,r)=>{var a;const f=m(r);if(s(f)){if(f.m&&!f.x)return f;if(Array.from(f.d).every((([e,t])=>E(o,e).n===t)))return f}f.d.clear();let u=!0;const p=n=>{if(e(r,n)){const e=m(n);if(!s(e)){if(!t(n))throw new Error("no atom init");_(n,e,n.init)}return l(e)}const i=E(o,n);try{return l(i)}finally{if(u)d(o,r,f,n,i);else{const e=c();d(e,r,f,n,i),S(e,r,f),v(e)}}};let h,y;const g={get signal(){return h||(h=new AbortController),h.signal},get setSelf(){return"production"===(import.meta.env?import.meta.env.MODE:void 0)||n(r)||console.warn("setSelf function cannot be used with read-only atom"),!y&&n(r)&&(y=(...e)=>{if("production"!==(import.meta.env?import.meta.env.MODE:void 0)&&u&&console.warn("setSelf function cannot be called in sync"),!u)return b(r,...e)}),y}};try{const e=w(r,p,g);if(_(r,f,e),i(e)){null==(a=e.onCancel)||a.call(e,(()=>null==h?void 0:h.abort()));const t=()=>{if(f.m){const e=c();S(e,r,f),v(e)}};e.then(t,t)}return f}catch(e){return delete f.v,f.e=e,delete f.x,++f.n,f}finally{u=!1}},g=(e,t,n)=>{var o,r;const i=new Map;for(const e of(null==(o=n.m)?void 0:o.t)||[]){const t=m(e);t.m&&i.set(e,t)}for(const e of n.p)i.set(e,m(e));return null==(r=((e,t)=>e.D.get(t))(e,t))||r.forEach((e=>{i.set(e,m(e))})),i},M=(n,o,...r)=>{let i=!0;const s=e=>l(E(n,e)),a=(r,...s)=>{const l=m(r);try{if(e(o,r)){if(!t(r))throw new Error("atom not writable");const e=l.n,o=s[0];return _(r,l,o),S(n,r,l),void(e!==l.n&&(u(n,r,l),((e,t,n)=>{const o=[],r=new Set,i=new Set,s=[[t,n]];for(;s.length>0;){const[t,n]=s[s.length-1];if(i.has(t))s.pop();else if(r.has(t))o.push([t,n,n.n]),i.add(t),n.x=!0,s.pop();else{r.add(t);for(const[o,i]of g(e,t,n))t===o||r.has(o)||s.push([o,i])}}f(e,"H",(()=>{const n=new Set([t]);for(let t=o.length-1;t>=0;--t){const[r,i,s]=o[t];let l=!1;for(const e of i.d.keys())if(e!==r&&n.has(e)){l=!0;break}l&&(E(e,r),S(e,r,i),s!==i.n&&(u(e,r,i),n.add(r))),delete i.x}}))})(n,r,l)))}return M(n,r,...s)}finally{i||v(n)}};try{return h(o,s,a,...r)}finally{i=!1}},b=(e,...t)=>{const n=c();try{return M(n,e,...t)}finally{v(n)}},S=(e,t,n)=>{if(n.m&&!r(n.v)){for(const o of n.d.keys())if(!n.m.d.has(o)){D(e,o,m(o)).t.add(t),n.m.d.add(o)}for(const o of n.m.d||[])if(!n.d.has(o)){n.m.d.delete(o);const r=O(e,o,m(o));null==r||r.t.delete(t)}}},D=(e,t,o)=>{if(!o.m){E(e,t);for(const n of o.d.keys()){D(e,n,m(n)).t.add(t)}if(o.m={l:new Set,d:new Set(o.d.keys()),t:new Set},n(t)){const n=o.m;let r;const i=(e,n)=>{let o=!0;r=(...n)=>{try{return M(e,t,...n)}finally{o||v(e)}};try{return n()}finally{o=!1}};f(e,"L",(()=>{const o=i(e,(()=>y(t,((...e)=>r(...e)))));o&&(n.u=e=>i(e,o))}))}}return o.m},O=(e,t,n)=>{if(!n.m||n.m.l.size||Array.from(n.m.t).some((e=>{var n;return null==(n=m(e).m)?void 0:n.d.has(t)})))return n.m;{const o=n.m.u;o&&f(e,"L",(()=>o(e))),delete n.m;for(const o of n.d.keys()){const n=O(e,o,m(o));null==n||n.t.delete(t)}}};return{get:e=>l(E(void 0,e)),set:b,sub:(e,t)=>{const n=c(),o=m(e),r=D(n,e,o).l;return r.add(t),v(n),()=>{r.delete(t);const n=c();O(n,e,o),v(n)}},unstable_derive:e=>p(...e(m,w,h,y))}},w=()=>{const e=new WeakMap,n=p((t=>{if("production"!==(import.meta.env?import.meta.env.MODE:void 0)&&!t)throw new Error("Atom is undefined or null");let n=e.get(t);return n||(n={d:new Map,p:new Set,n:0},e.set(t,n)),n}),((e,...t)=>e.read(...t)),((e,...t)=>e.write(...t)),((e,...t)=>{var n;return null==(n=e.onMount)?void 0:n.call(e,...t)}));return"production"!==(import.meta.env?import.meta.env.MODE:void 0)?(e=>{const n=new WeakMap,o=new Set;let r,i=0;const s=e.unstable_derive(((e,t,s,l)=>(r=e,[t=>{let r=n.get(t);if(!r){const i=e(t);r=new Proxy(i,{set:(e,n,r)=>("m"===n&&o.add(t),Reflect.set(e,n,r)),deleteProperty:(e,n)=>("m"===n&&o.delete(t),Reflect.deleteProperty(e,n))}),n.set(t,r)}return r},t,(e,t,n,...o)=>i?n(e,...o):s(e,t,n,...o),l]))),l=s.set,a={dev4_get_internal_weak_map:()=>({get:e=>{const t=r(e);if(0!==t.n)return t}}),dev4_get_mounted_atoms:()=>o,dev4_restore_atoms:e=>{l({read:()=>null,write:(n,o)=>{++i;try{for(const[n,r]of e)t(n)&&o(n,r)}finally{--i}}})}};return Object.assign(s,a)})(n):n};let h;const y=()=>(h||(h=w(),"production"!==(import.meta.env?import.meta.env.MODE:void 0)&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=h),globalThis.__JOTAI_DEFAULT_STORE__!==h&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"))),h);export{w as createStore,y as getDefaultStore};
//# sourceMappingURL=vanilla.mjs.js.map
