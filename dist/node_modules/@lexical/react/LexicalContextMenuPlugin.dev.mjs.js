import{useLexicalComposerContext as t}from"./LexicalComposerContext.mjs.js";import{calculateZoomLevel as e,mergeRegister as n}from"@lexical/utils";import{createCommand as o,isDOMNode as l,COMMAND_PRIORITY_LOW as r,KEY_ARROW_DOWN_COMMAND as i,KEY_ARROW_UP_COMMAND as u,KEY_ESCAPE_COMMAND as s,KEY_TAB_COMMAND as c,KEY_ENTER_COMMAND as a,$getSelection as m,$isRangeSelection as d}from"lexical";import*as p from"react";import{useState as f,useCallback as g,useEffect as h,useMemo as v,useRef as w,useLayoutEffect as y}from"react";import"../../react/jsx-runtime.js";import{j as b}from"../../../_virtual/jsx-runtime.js";const x="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,C=x?y:h;class E{constructor(t){this.key=t,this.ref={current:null},this.setRefElement=this.setRefElement.bind(this)}setRefElement(t){this.ref={current:t}}}const R=t=>{const e=document.getElementById("typeahead-menu");if(!e)return;const n=e.getBoundingClientRect();n.top+n.height>window.innerHeight&&e.scrollIntoView({block:"center"}),n.top<0&&e.scrollIntoView({block:"center"}),t.scrollIntoView({block:"nearest"})};function O(t,e){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return n.top>o.top&&n.top<o.bottom}function I(e,n,o,l){const[r]=t();h((()=>{if(null!=n&&null!=e){const t=r.getRootElement(),e=null!=t?function(t){let e=getComputedStyle(t);const n="absolute"===e.position,o=/(auto|scroll)/;if("fixed"===e.position)return document.body;for(let l=t;l=l.parentElement;)if(e=getComputedStyle(l),(!n||"static"!==e.position)&&o.test(e.overflow+e.overflowY+e.overflowX))return l;return document.body}(t):document.body;let i=!1,u=O(n,e);const s=function(){i||(window.requestAnimationFrame((function(){o(),i=!1})),i=!0);const t=O(n,e);t!==u&&(u=t,null!=l&&l(t))},c=new ResizeObserver(o);return window.addEventListener("resize",o),document.addEventListener("scroll",s,{capture:!0,passive:!0}),c.observe(n),()=>{c.unobserve(n),window.removeEventListener("resize",o),document.removeEventListener("scroll",s,!0)}}}),[n,r,l,o,e])}const A=o("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function S({close:t,editor:e,anchorElementRef:o,resolution:l,options:p,menuRenderFn:w,onSelectOption:y,shouldSplitNodeWithQuery:b=!1,commandPriority:x=r}){const[E,O]=f(null),I=l.match&&l.match.matchingString;h((()=>{O(0)}),[I]);const S=g((n=>{e.update((()=>{const e=null!=l.match&&b?function(t){const e=m();if(!d(e)||!e.isCollapsed())return null;const n=e.anchor;if("text"!==n.type)return null;const o=n.getNode();if(!o.isSimpleText())return null;const l=n.offset,r=o.getTextContent().slice(0,l),i=t.replaceableString.length,u=l-function(t,e,n){let o=n;for(let n=o;n<=e.length;n++)t.slice(-n)===e.substring(0,n)&&(o=n);return o}(r,t.matchingString,i);if(u<0)return null;let s;return 0===u?[s]=o.splitText(l):[,s]=o.splitText(u,l),s}(l.match):null;y(n,e,t,l.match?l.match.matchingString:"")}))}),[e,b,l.match,y,t]),L=g((t=>{const n=e.getRootElement();null!==n&&(n.setAttribute("aria-activedescendant","typeahead-item-"+t),O(t))}),[e]);h((()=>()=>{const t=e.getRootElement();null!==t&&t.removeAttribute("aria-activedescendant")}),[e]),C((()=>{null===p?O(null):null===E&&L(0)}),[p,E,L]),h((()=>n(e.registerCommand(A,(({option:t})=>!(!t.ref||null==t.ref.current)&&(R(t.ref.current),!0)),x))),[e,L,x]),h((()=>n(e.registerCommand(i,(t=>{const n=t;if(null!==p&&p.length&&null!==E){const t=E!==p.length-1?E+1:0;L(t);const o=p[t];null!=o.ref&&o.ref.current&&e.dispatchCommand(A,{index:t,option:o}),n.preventDefault(),n.stopImmediatePropagation()}return!0}),x),e.registerCommand(u,(t=>{const e=t;if(null!==p&&p.length&&null!==E){const t=0!==E?E-1:p.length-1;L(t);const n=p[t];null!=n.ref&&n.ref.current&&R(n.ref.current),e.preventDefault(),e.stopImmediatePropagation()}return!0}),x),e.registerCommand(s,(e=>{const n=e;return n.preventDefault(),n.stopImmediatePropagation(),t(),!0}),x),e.registerCommand(c,(t=>{const e=t;return null!==p&&null!==E&&null!=p[E]&&(e.preventDefault(),e.stopImmediatePropagation(),S(p[E]),!0)}),x),e.registerCommand(a,(t=>null!==p&&null!==E&&null!=p[E]&&(null!==t&&(t.preventDefault(),t.stopImmediatePropagation()),S(p[E]),!0)),x))),[S,t,e,p,E,L,x]);return w(o,v((()=>({options:p,selectOptionAndCleanUp:S,selectedIndex:E,setHighlightedIndex:O})),[S,E,p]),l.match?l.match.matchingString:"")}function L(t,e){null!=e&&(t.className=e),t.setAttribute("aria-label","Typeahead menu"),t.setAttribute("role","listbox"),t.style.display="block",t.style.position="absolute"}function P({options:n,onWillOpen:o,onClose:i,onOpen:u,onSelectOption:s,menuRenderFn:c,anchorClassName:a,commandPriority:m=r,parent:d}){const[v]=t(),[y,C]=f(null),E=p.useRef(null),R=function(e,n,o,l=(x?document.body:void 0),r=!0){const[i]=t(),u=w(x?document.createElement("div"):null),s=g((()=>{if(null===u.current||void 0===l)return;u.current.style.top=u.current.style.bottom;const t=i.getRootElement(),n=u.current,s=n.firstChild;if(null!==t&&null!==e){const{left:i,top:c,width:a,height:m}=e.getRect(),d=u.current.offsetHeight;if(n.style.top=`${c+d+3+(r?window.pageYOffset:0)}px`,n.style.left=`${i+window.pageXOffset}px`,n.style.height=`${m}px`,n.style.width=`${a}px`,null!==s){s.style.top=`${c}`;const e=s.getBoundingClientRect(),o=e.height,l=e.width,u=t.getBoundingClientRect();i+l>u.right&&(n.style.left=`${u.right-l+window.pageXOffset}px`),(c+o>window.innerHeight||c+o>u.bottom)&&c-u.top>o+m&&(n.style.top=`${c-o-m+(r?window.pageYOffset:0)}px`)}n.isConnected||(L(n,o),l.append(n)),n.setAttribute("id","typeahead-menu"),u.current=n,t.setAttribute("aria-controls","typeahead-menu")}}),[i,e,r,o,l]);h((()=>{const t=i.getRootElement();return null!==e&&s(),()=>{null!==t&&t.removeAttribute("aria-controls");const e=u.current;null!==e&&e.isConnected&&(e.remove(),e.removeAttribute("id"))}}),[i,s,e]);const c=g((t=>{null!==e&&(t||n(null))}),[e,n]);I(e,u.current,s,c);const a=u.current;return null!=a&&(L(a,o),null!=l&&l.append(a)),u}(y,C,a,d),O=g((()=>{C(null),null!=i&&null!==y&&i()}),[i,y]),A=g((t=>{C(t),null!=u&&null===y&&u(t)}),[u,y]),P=g((t=>{t.preventDefault(),null!=o&&o(t);const n=e(t.target);A({getRect:()=>new DOMRect(t.clientX/n,t.clientY/n,1,1)})}),[A,o]),D=g((t=>{null!==y&&null!=E.current&&null!=t.target&&l(t.target)&&!E.current.contains(t.target)&&O()}),[O,y]);return h((()=>{const t=v.getRootElement();if(t)return t.addEventListener("contextmenu",P),()=>t.removeEventListener("contextmenu",P)}),[v,P]),h((()=>(document.addEventListener("click",D),()=>document.removeEventListener("click",D))),[v,D]),null===R.current||null===y||null===v?null:b.exports.jsx(S,{close:O,resolution:y,editor:v,anchorElementRef:R,options:n,menuRenderFn:(t,e)=>c(t,e,{setMenuRef:t=>{E.current=t}}),onSelectOption:s,commandPriority:m})}export{P as LexicalContextMenuPlugin,E as MenuOption};
//# sourceMappingURL=LexicalContextMenuPlugin.dev.mjs.js.map
