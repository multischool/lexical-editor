import{useLexicalComposerContext as t}from"./LexicalComposerContext.mjs.js";import{createCommand as e,$getSelection as n,$isRangeSelection as o,$isTextNode as r,getDOMSelection as l,COMMAND_PRIORITY_LOW as i,KEY_ARROW_DOWN_COMMAND as s,KEY_ARROW_UP_COMMAND as u,KEY_ESCAPE_COMMAND as c,KEY_TAB_COMMAND as a,KEY_ENTER_COMMAND as d}from"lexical";import m,{useEffect as f,useCallback as p,useState as g,useRef as h,useMemo as y,useLayoutEffect as w}from"react";import{mergeRegister as v}from"@lexical/utils";import"../../react/jsx-runtime.js";import{j as C}from"../../../_virtual/jsx-runtime.js";const b="startTransition",E="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,x=E?w:f;class O{constructor(t){this.key=t,this.ref={current:null},this.setRefElement=this.setRefElement.bind(this)}setRefElement(t){this.ref={current:t}}}const S=t=>{const e=document.getElementById("typeahead-menu");if(!e)return;const n=e.getBoundingClientRect();n.top+n.height>window.innerHeight&&e.scrollIntoView({block:"center"}),n.top<0&&e.scrollIntoView({block:"center"}),t.scrollIntoView({block:"nearest"})};function R(t,e){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return n.top>o.top&&n.top<o.bottom}function T(e,n,o,r){const[l]=t();f((()=>{if(null!=n&&null!=e){const t=l.getRootElement(),e=null!=t?function(t){let e=getComputedStyle(t);const n="absolute"===e.position,o=/(auto|scroll)/;if("fixed"===e.position)return document.body;for(let r=t;r=r.parentElement;)if(e=getComputedStyle(r),(!n||"static"!==e.position)&&o.test(e.overflow+e.overflowY+e.overflowX))return r;return document.body}(t):document.body;let i=!1,s=R(n,e);const u=function(){i||(window.requestAnimationFrame((function(){o(),i=!1})),i=!0);const t=R(n,e);t!==s&&(s=t,null!=r&&r(t))},c=new ResizeObserver(o);return window.addEventListener("resize",o),document.addEventListener("scroll",u,{capture:!0,passive:!0}),c.observe(n),()=>{c.unobserve(n),window.removeEventListener("resize",o),document.removeEventListener("scroll",u,!0)}}}),[n,l,r,o,e])}const I=e("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function A({close:t,editor:e,anchorElementRef:r,resolution:l,options:m,menuRenderFn:h,onSelectOption:w,shouldSplitNodeWithQuery:C=!1,commandPriority:b=i}){const[E,O]=g(null),R=l.match&&l.match.matchingString;f((()=>{O(0)}),[R]);const T=p((r=>{e.update((()=>{const e=null!=l.match&&C?function(t){const e=n();if(!o(e)||!e.isCollapsed())return null;const r=e.anchor;if("text"!==r.type)return null;const l=r.getNode();if(!l.isSimpleText())return null;const i=r.offset,s=l.getTextContent().slice(0,i),u=t.replaceableString.length,c=i-function(t,e,n){let o=n;for(let n=o;n<=e.length;n++)t.slice(-n)===e.substring(0,n)&&(o=n);return o}(s,t.matchingString,u);if(c<0)return null;let a;return 0===c?[a]=l.splitText(i):[,a]=l.splitText(c,i),a}(l.match):null;w(r,e,t,l.match?l.match.matchingString:"")}))}),[e,C,l.match,w,t]),A=p((t=>{const n=e.getRootElement();null!==n&&(n.setAttribute("aria-activedescendant","typeahead-item-"+t),O(t))}),[e]);return f((()=>()=>{const t=e.getRootElement();null!==t&&t.removeAttribute("aria-activedescendant")}),[e]),x((()=>{null===m?O(null):null===E&&A(0)}),[m,E,A]),f((()=>v(e.registerCommand(I,(({option:t})=>!(!t.ref||null==t.ref.current||(S(t.ref.current),0))),b))),[e,A,b]),f((()=>v(e.registerCommand(s,(t=>{const n=t;if(null!==m&&m.length&&null!==E){const t=E!==m.length-1?E+1:0;A(t);const o=m[t];null!=o.ref&&o.ref.current&&e.dispatchCommand(I,{index:t,option:o}),n.preventDefault(),n.stopImmediatePropagation()}return!0}),b),e.registerCommand(u,(t=>{const e=t;if(null!==m&&m.length&&null!==E){const t=0!==E?E-1:m.length-1;A(t);const n=m[t];null!=n.ref&&n.ref.current&&S(n.ref.current),e.preventDefault(),e.stopImmediatePropagation()}return!0}),b),e.registerCommand(c,(e=>{const n=e;return n.preventDefault(),n.stopImmediatePropagation(),t(),!0}),b),e.registerCommand(a,(t=>{const e=t;return null!==m&&null!==E&&null!=m[E]&&(e.preventDefault(),e.stopImmediatePropagation(),T(m[E]),!0)}),b),e.registerCommand(d,(t=>null!==m&&null!==E&&null!=m[E]&&(null!==t&&(t.preventDefault(),t.stopImmediatePropagation()),T(m[E]),!0)),b))),[T,t,e,m,E,A,b]),h(r,y((()=>({options:m,selectOptionAndCleanUp:T,selectedIndex:E,setHighlightedIndex:O})),[T,E,m]),l.match?l.match.matchingString:"")}function N(t,e){null!=e&&(t.className=e),t.setAttribute("aria-label","Typeahead menu"),t.setAttribute("role","listbox"),t.style.display="block",t.style.position="absolute"}const P="\\.,\\+\\*\\?\\$\\@\\|#{}\\(\\)\\^\\-\\[\\]\\\\/!%'\"~=<>_:;";function _(t,e){let n=getComputedStyle(t);const o="absolute"===n.position,r=e?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===n.position)return document.body;for(let e=t;e=e.parentElement;)if(n=getComputedStyle(e),(!o||"static"!==n.position)&&r.test(n.overflow+n.overflowY+n.overflowX))return e;return document.body}const L=e("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function D(t,{minLength:e=1,maxLength:n=75}){return p((o=>{const r=new RegExp("(^|\\s|\\()(["+t+"]((?:[^"+t+P+"\\s]){0,"+n+"}))$").exec(o);if(null!==r){const t=r[1],n=r[3];if(n.length>=e)return{leadOffset:r.index+t.length,matchingString:n,replaceableString:r[2]}}return null}),[n,e,t])}function M({options:e,onQueryChange:s,onSelectOption:u,onOpen:c,onClose:a,menuRenderFn:d,triggerFn:y,anchorClassName:w,commandPriority:v=i,parent:x}){const[O]=t(),[S,R]=g(null),I=function(e,n,o,r=(E?document.body:void 0),l=!0){const[i]=t(),s=h(E?document.createElement("div"):null),u=p((()=>{if(null===s.current||void 0===r)return;s.current.style.top=s.current.style.bottom;const t=i.getRootElement(),n=s.current,u=n.firstChild;if(null!==t&&null!==e){const{left:i,top:c,width:a,height:d}=e.getRect(),m=s.current.offsetHeight;if(n.style.top=`${c+m+3+(l?window.pageYOffset:0)}px`,n.style.left=`${i+window.pageXOffset}px`,n.style.height=`${d}px`,n.style.width=`${a}px`,null!==u){u.style.top=`${c}`;const e=u.getBoundingClientRect(),o=e.height,r=e.width,s=t.getBoundingClientRect();i+r>s.right&&(n.style.left=`${s.right-r+window.pageXOffset}px`),(c+o>window.innerHeight||c+o>s.bottom)&&c-s.top>o+d&&(n.style.top=`${c-o-d+(l?window.pageYOffset:0)}px`)}n.isConnected||(N(n,o),r.append(n)),n.setAttribute("id","typeahead-menu"),s.current=n,t.setAttribute("aria-controls","typeahead-menu")}}),[i,e,l,o,r]);f((()=>{const t=i.getRootElement();return null!==e&&u(),()=>{null!==t&&t.removeAttribute("aria-controls");const e=s.current;null!==e&&e.isConnected&&(e.remove(),e.removeAttribute("id"))}}),[i,u,e]);const c=p((t=>{null!==e&&(t||n(null))}),[e,n]);T(e,s.current,u,c);const a=s.current;return null!=a&&(N(a,o),null!=r&&r.append(a)),s}(S,R,w,x),P=p((()=>{R(null),null!=a&&null!==S&&a()}),[a,S]),_=p((t=>{R(t),null!=c&&null===S&&c(t)}),[c,S]);return f((()=>{const t=O.registerUpdateListener((()=>{O.getEditorState().read((()=>{if(!O.isEditable())return void P();const t=O._window||window,e=t.document.createRange(),i=n(),u=function(t){let e=null;return t.getEditorState().read((()=>{const t=n();o(t)&&(e=function(t){const e=t.anchor;if("text"!==e.type)return null;const n=e.getNode();if(!n.isSimpleText())return null;const o=e.offset;return n.getTextContent().slice(0,o)}(t))})),e}(O);if(!o(i)||!i.isCollapsed()||null===u||null===e)return void P();const c=y(u,O);if(s(c?c.matchingString:null),null!==c&&!function(t,e){return 0===e&&t.getEditorState().read((()=>{const t=n();if(o(t)){const e=t.anchor.getNode().getPreviousSibling();return r(e)&&e.isTextEntity()}return!1}))}(O,c.leadOffset)){const n=function(t,e,n){const o=l(n);if(null===o||!o.isCollapsed)return!1;const r=o.anchorNode,i=t,s=o.anchorOffset;if(null==r||null==s)return!1;try{e.setStart(r,i),e.setEnd(r,s)}catch(t){return!1}return!0}(c.leadOffset,e,t);if(null!==n)return a=()=>_({getRect:()=>e.getBoundingClientRect(),match:c}),void(b in m?m[b](a):a())}var a;P()}))}));return()=>{t()}}),[O,y,s,S,P,_]),f((()=>O.registerEditableListener((t=>{t||P()}))),[O,P]),null===S||null===O||null===I.current?null:C.exports.jsx(A,{close:P,resolution:S,editor:O,anchorElementRef:I,options:e,menuRenderFn:d,shouldSplitNodeWithQuery:!0,onSelectOption:u,commandPriority:v})}export{M as LexicalTypeaheadMenuPlugin,O as MenuOption,P as PUNCTUATION,L as SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND,_ as getScrollParent,D as useBasicTypeaheadTriggerMatch,T as useDynamicPositioning};
//# sourceMappingURL=LexicalTypeaheadMenuPlugin.prod.mjs.js.map
