import{mergeRegister as t}from"@lexical/utils";import{UNDO_COMMAND as e,CAN_REDO_COMMAND as n,CAN_UNDO_COMMAND as r,COMMAND_PRIORITY_EDITOR as o,REDO_COMMAND as i,CLEAR_EDITOR_COMMAND as s,CLEAR_HISTORY_COMMAND as c,$isRangeSelection as a,$isTextNode as u,$isRootNode as d}from"lexical";function l(t,e,n,r,o){if(null===t||0===n.size&&0===r.size&&!o)return 0;const i=e._selection,s=t._selection;if(o)return 1;if(!(a(i)&&a(s)&&s.isCollapsed()&&i.isCollapsed()))return 0;const c=function(t,e,n){const r=t._nodeMap,o=[];for(const t of e){const e=r.get(t);void 0!==e&&o.push(e)}for(const[t,e]of n){if(!e)continue;const n=r.get(t);void 0===n||d(n)||o.push(n)}return o}(e,n,r);if(0===c.length)return 0;if(c.length>1){const n=e._nodeMap,r=n.get(i.anchor.key),o=n.get(s.anchor.key);return r&&o&&!t._nodeMap.has(r.__key)&&u(r)&&1===r.__text.length&&1===i.anchor.offset?2:0}const l=c[0],f=t._nodeMap.get(l.__key);if(!u(f)||!u(l)||f.__mode!==l.__mode)return 0;const p=f.__text,h=l.__text;if(p===h)return 0;const m=i.anchor,g=s.anchor;if(m.key!==g.key||"text"!==m.type)return 0;const _=m.offset,S=g.offset,y=h.length-p.length;return 1===y&&S===_-1?2:-1===y&&S===_+1?3:-1===y&&S===_?4:0}function f(t,e){let n=Date.now(),r=0;return(o,i,s,c,d,f)=>{const p=Date.now();if(f.has("historic"))return r=0,n=p,2;const h=l(o,i,c,d,t.isComposing()),m=(()=>{const l=null===s||s.editor===t,m=f.has("history-push");if(!m&&l&&f.has("history-merge"))return 0;if(null===o)return 1;const g=i._selection;return c.size>0||d.size>0?!1===m&&0!==h&&h===r&&p<n+e&&l||1===c.size&&function(t,e,n){const r=e._nodeMap.get(t),o=n._nodeMap.get(t),i=e._selection,s=n._selection;return!(a(i)&&a(s)&&"element"===i.anchor.type&&"element"===i.focus.type&&"text"===s.anchor.type&&"text"===s.focus.type||!u(r)||!u(o)||r.__parent!==o.__parent)&&JSON.stringify(e.read((()=>r.exportJSON())))===JSON.stringify(n.read((()=>o.exportJSON())))}(Array.from(c)[0],o,i)?0:1:null!==g?0:2})();return n=p,r=h,m}}function p(t){t.undoStack=[],t.redoStack=[],t.current=null}function h(a,u,d){const l=f(a,d),h=t(a.registerCommand(e,(()=>(function(t,e){const o=e.redoStack,i=e.undoStack;if(0!==i.length){const s=e.current,c=i.pop();null!==s&&(o.push(s),t.dispatchCommand(n,!0)),0===i.length&&t.dispatchCommand(r,!1),e.current=c||null,c&&c.editor.setEditorState(c.editorState,{tag:"historic"})}}(a,u),!0)),o),a.registerCommand(i,(()=>(function(t,e){const o=e.redoStack,i=e.undoStack;if(0!==o.length){const s=e.current;null!==s&&(i.push(s),t.dispatchCommand(r,!0));const c=o.pop();0===o.length&&t.dispatchCommand(n,!1),e.current=c||null,c&&c.editor.setEditorState(c.editorState,{tag:"historic"})}}(a,u),!0)),o),a.registerCommand(s,(()=>(p(u),!1)),o),a.registerCommand(c,(()=>(p(u),a.dispatchCommand(n,!1),a.dispatchCommand(r,!1),!0)),o),a.registerUpdateListener((({editorState:t,prevEditorState:e,dirtyLeaves:o,dirtyElements:i,tags:s})=>{const c=u.current,d=u.redoStack,f=u.undoStack,p=null===c?null:c.editorState;if(null!==c&&t===p)return;const h=l(e,t,c,o,i,s);if(1===h)0!==d.length&&(u.redoStack=[],a.dispatchCommand(n,!1)),null!==c&&(f.push({...c}),a.dispatchCommand(r,!0));else if(2===h)return;u.current={editor:a,editorState:t}})));return h}function m(){return{current:null,redoStack:[],undoStack:[]}}export{m as createEmptyHistoryState,h as registerHistory};
//# sourceMappingURL=LexicalHistory.prod.mjs.js.map
