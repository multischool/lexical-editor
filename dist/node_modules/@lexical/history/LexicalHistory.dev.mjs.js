import{mergeRegister as t}from"@lexical/utils";import{UNDO_COMMAND as e,COMMAND_PRIORITY_EDITOR as n,REDO_COMMAND as r,CLEAR_EDITOR_COMMAND as o,CLEAR_HISTORY_COMMAND as i,CAN_REDO_COMMAND as s,CAN_UNDO_COMMAND as c,$isRangeSelection as a,$isTextNode as u,$isRootNode as d}from"lexical";function l(t,e,n,r,o){if(null===t||0===n.size&&0===r.size&&!o)return 0;const i=e._selection,s=t._selection;if(o)return 1;if(!(a(i)&&a(s)&&s.isCollapsed()&&i.isCollapsed()))return 0;const c=function(t,e,n){const r=t._nodeMap,o=[];for(const t of e){const e=r.get(t);void 0!==e&&o.push(e)}for(const[t,e]of n){if(!e)continue;const n=r.get(t);void 0===n||d(n)||o.push(n)}return o}(e,n,r);if(0===c.length)return 0;if(c.length>1){const n=e._nodeMap,r=n.get(i.anchor.key),o=n.get(s.anchor.key);return r&&o&&!t._nodeMap.has(r.__key)&&u(r)&&1===r.__text.length&&1===i.anchor.offset?2:0}const l=c[0],f=t._nodeMap.get(l.__key);if(!u(f)||!u(l)||f.__mode!==l.__mode)return 0;const p=f.__text,h=l.__text;if(p===h)return 0;const m=i.anchor,g=s.anchor;if(m.key!==g.key||"text"!==m.type)return 0;const _=m.offset,S=g.offset,y=h.length-p.length;return 1===y&&S===_-1?2:-1===y&&S===_+1?3:-1===y&&S===_?4:0}function f(t,e){let n=Date.now(),r=0;return(o,i,s,c,d,f)=>{const p=Date.now();if(f.has("historic"))return r=0,n=p,2;const h=l(o,i,c,d,t.isComposing()),m=(()=>{const l=null===s||s.editor===t,m=f.has("history-push");if(!m&&l&&f.has("history-merge"))return 0;if(null===o)return 1;const g=i._selection;if(!(c.size>0||d.size>0))return null!==g?0:2;if(!1===m&&0!==h&&h===r&&p<n+e&&l)return 0;if(1===c.size){if(function(t,e,n){const r=e._nodeMap.get(t),o=n._nodeMap.get(t),i=e._selection,s=n._selection;return!(a(i)&&a(s)&&"element"===i.anchor.type&&"element"===i.focus.type&&"text"===s.anchor.type&&"text"===s.focus.type||!u(r)||!u(o)||r.__parent!==o.__parent)&&JSON.stringify(e.read((()=>r.exportJSON())))===JSON.stringify(n.read((()=>o.exportJSON())))}(Array.from(c)[0],o,i))return 0}return 1})();return n=p,r=h,m}}function p(t){t.undoStack=[],t.redoStack=[],t.current=null}function h(a,u,d){const l=f(a,d),h=t(a.registerCommand(e,(()=>(function(t,e){const n=e.redoStack,r=e.undoStack;if(0!==r.length){const o=e.current,i=r.pop();null!==o&&(n.push(o),t.dispatchCommand(s,!0)),0===r.length&&t.dispatchCommand(c,!1),e.current=i||null,i&&i.editor.setEditorState(i.editorState,{tag:"historic"})}}(a,u),!0)),n),a.registerCommand(r,(()=>(function(t,e){const n=e.redoStack,r=e.undoStack;if(0!==n.length){const o=e.current;null!==o&&(r.push(o),t.dispatchCommand(c,!0));const i=n.pop();0===n.length&&t.dispatchCommand(s,!1),e.current=i||null,i&&i.editor.setEditorState(i.editorState,{tag:"historic"})}}(a,u),!0)),n),a.registerCommand(o,(()=>(p(u),!1)),n),a.registerCommand(i,(()=>(p(u),a.dispatchCommand(s,!1),a.dispatchCommand(c,!1),!0)),n),a.registerUpdateListener((({editorState:t,prevEditorState:e,dirtyLeaves:n,dirtyElements:r,tags:o})=>{const i=u.current,d=u.redoStack,f=u.undoStack,p=null===i?null:i.editorState;if(null!==i&&t===p)return;const h=l(e,t,i,n,r,o);if(1===h)0!==d.length&&(u.redoStack=[],a.dispatchCommand(s,!1)),null!==i&&(f.push({...i}),a.dispatchCommand(c,!0));else if(2===h)return;u.current={editor:a,editorState:t}})));return h}function m(){return{current:null,redoStack:[],undoStack:[]}}export{m as createEmptyHistoryState,h as registerHistory};
//# sourceMappingURL=LexicalHistory.dev.mjs.js.map
