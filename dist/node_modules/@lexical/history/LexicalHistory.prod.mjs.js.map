{"version":3,"file":"LexicalHistory.prod.mjs.js","sources":["../../../../node_modules/@lexical/history/LexicalHistory.prod.mjs"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\nimport{mergeRegister as t}from\"@lexical/utils\";import{UNDO_COMMAND as e,COMMAND_PRIORITY_EDITOR as n,REDO_COMMAND as r,CLEAR_EDITOR_COMMAND as o,CLEAR_HISTORY_COMMAND as i,CAN_REDO_COMMAND as s,CAN_UNDO_COMMAND as c,$isRangeSelection as a,$isTextNode as u,$isRootNode as d}from\"lexical\";const l=0,f=1,p=2,h=0,m=1,g=2,_=3,S=4;function y(t,e,n,r,o){if(null===t||0===n.size&&0===r.size&&!o)return h;const i=e._selection,s=t._selection;if(o)return m;if(!(a(i)&&a(s)&&s.isCollapsed()&&i.isCollapsed()))return h;const c=function(t,e,n){const r=t._nodeMap,o=[];for(const t of e){const e=r.get(t);void 0!==e&&o.push(e)}for(const[t,e]of n){if(!e)continue;const n=r.get(t);void 0===n||d(n)||o.push(n)}return o}(e,n,r);if(0===c.length)return h;if(c.length>1){const n=e._nodeMap,r=n.get(i.anchor.key),o=n.get(s.anchor.key);return r&&o&&!t._nodeMap.has(r.__key)&&u(r)&&1===r.__text.length&&1===i.anchor.offset?g:h}const l=c[0],f=t._nodeMap.get(l.__key);if(!u(f)||!u(l)||f.__mode!==l.__mode)return h;const p=f.__text,y=l.__text;if(p===y)return h;const k=i.anchor,C=s.anchor;if(k.key!==C.key||\"text\"!==k.type)return h;const x=k.offset,M=C.offset,z=y.length-p.length;return 1===z&&M===x-1?g:-1===z&&M===x+1?_:-1===z&&M===x?S:h}function k(t,e){let n=Date.now(),r=h;return(o,i,s,c,d,m)=>{const g=Date.now();if(m.has(\"historic\"))return r=h,n=g,p;const _=y(o,i,c,d,t.isComposing()),S=(()=>{const S=null===s||s.editor===t,y=m.has(\"history-push\");if(!y&&S&&m.has(\"history-merge\"))return l;if(null===o)return f;const k=i._selection;if(!(c.size>0||d.size>0))return null!==k?l:p;if(!1===y&&_!==h&&_===r&&g<n+e&&S)return l;if(1===c.size){if(function(t,e,n){const r=e._nodeMap.get(t),o=n._nodeMap.get(t),i=e._selection,s=n._selection;return!(a(i)&&a(s)&&\"element\"===i.anchor.type&&\"element\"===i.focus.type&&\"text\"===s.anchor.type&&\"text\"===s.focus.type||!u(r)||!u(o)||r.__parent!==o.__parent)&&JSON.stringify(e.read((()=>r.exportJSON())))===JSON.stringify(n.read((()=>o.exportJSON())))}(Array.from(c)[0],o,i))return l}return f})();return n=g,r=_,S}}function C(t){t.undoStack=[],t.redoStack=[],t.current=null}function x(a,u,d){const l=k(a,d),h=t(a.registerCommand(e,(()=>(function(t,e){const n=e.redoStack,r=e.undoStack;if(0!==r.length){const o=e.current,i=r.pop();null!==o&&(n.push(o),t.dispatchCommand(s,!0)),0===r.length&&t.dispatchCommand(c,!1),e.current=i||null,i&&i.editor.setEditorState(i.editorState,{tag:\"historic\"})}}(a,u),!0)),n),a.registerCommand(r,(()=>(function(t,e){const n=e.redoStack,r=e.undoStack;if(0!==n.length){const o=e.current;null!==o&&(r.push(o),t.dispatchCommand(c,!0));const i=n.pop();0===n.length&&t.dispatchCommand(s,!1),e.current=i||null,i&&i.editor.setEditorState(i.editorState,{tag:\"historic\"})}}(a,u),!0)),n),a.registerCommand(o,(()=>(C(u),!1)),n),a.registerCommand(i,(()=>(C(u),a.dispatchCommand(s,!1),a.dispatchCommand(c,!1),!0)),n),a.registerUpdateListener((({editorState:t,prevEditorState:e,dirtyLeaves:n,dirtyElements:r,tags:o})=>{const i=u.current,d=u.redoStack,h=u.undoStack,m=null===i?null:i.editorState;if(null!==i&&t===m)return;const g=l(e,t,i,n,r,o);if(g===f)0!==d.length&&(u.redoStack=[],a.dispatchCommand(s,!1)),null!==i&&(h.push({...i}),a.dispatchCommand(c,!0));else if(g===p)return;u.current={editor:a,editorState:t}})));return h}function M(){return{current:null,redoStack:[],undoStack:[]}}export{M as createEmptyHistoryState,x as registerHistory};\n"],"names":["y","t","e","n","r","o","size","i","_selection","s","a","isCollapsed","c","_nodeMap","get","push","d","length","anchor","key","has","__key","u","__text","offset","l","f","__mode","p","k","C","type","x","M","z","Date","now","m","g","_","isComposing","S","editor","focus","__parent","JSON","stringify","read","exportJSON","Array","from","undoStack","redoStack","current","h","registerCommand","pop","dispatchCommand","setEditorState","editorState","tag","registerUpdateListener","prevEditorState","dirtyLeaves","dirtyElements","tags"],"mappings":"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"}