import{justify as n}from"./align.js";import t from"./constant.js";import o from"../node_modules/d3-array/src/sum.js";import e from"../node_modules/d3-array/src/max.js";import r from"../node_modules/d3-array/src/min.js";function s(n,t){return f(n.source,t.source)||n.index-t.index}function i(n,t){return f(n.target,t.target)||n.index-t.index}function f(n,t){return n.y0-t.y0}function c(n){return n.value}function u(n){return n.index}function l(n){return n.nodes}function a(n){return n.links}function d(n,t){const o=n.get(t);if(!o)throw new Error("missing: "+t);return o}function g({nodes:n}){for(const t of n){let n=t.y0,o=n;for(const o of t.sourceLinks)o.y0=n+o.width/2,n+=o.width;for(const n of t.targetLinks)n.y1=o+n.width/2,o+=n.width}}function h(){let h,y,k,L=0,p=0,w=1,m=1,x=24,v=8,M=u,S=n,j=l,b=a,z=6;function E(){const n={nodes:j.apply(null,arguments),links:b.apply(null,arguments)};return function({nodes:n,links:t}){for(const[t,o]of n.entries())o.index=t,o.sourceLinks=[],o.targetLinks=[];const o=new Map(n.map(((t,o)=>[M(t,o,n),t])));for(const[n,e]of t.entries()){e.index=n;let{source:t,target:r}=e;"object"!=typeof t&&(t=e.source=d(o,t)),"object"!=typeof r&&(r=e.target=d(o,r)),t.sourceLinks.push(e),r.targetLinks.push(e)}if(null!=k)for(const{sourceLinks:t,targetLinks:o}of n)t.sort(k),o.sort(k)}(n),function({nodes:n}){for(const t of n)t.value=void 0===t.fixedValue?Math.max(o(t.sourceLinks,c),o(t.targetLinks,c)):t.fixedValue}(n),function({nodes:n}){const t=n.length;let o=new Set(n),e=new Set,r=0;for(;o.size;){for(const n of o){n.depth=r;for(const{target:t}of n.sourceLinks)e.add(t)}if(++r>t)throw new Error("circular link");o=e,e=new Set}}(n),function({nodes:n}){const t=n.length;let o=new Set(n),e=new Set,r=0;for(;o.size;){for(const n of o){n.height=r;for(const{source:t}of n.targetLinks)e.add(t)}if(++r>t)throw new Error("circular link");o=e,e=new Set}}(n),function(n){const t=function({nodes:n}){const t=e(n,(n=>n.depth))+1,o=(w-L-x)/(t-1),r=new Array(t);for(const e of n){const n=Math.max(0,Math.min(t-1,Math.floor(S.call(null,e,t))));e.layer=n,e.x0=L+n*o,e.x1=e.x0+x,r[n]?r[n].push(e):r[n]=[e]}if(y)for(const n of r)n.sort(y);return r}(n);h=Math.min(v,(m-p)/(e(t,(n=>n.length))-1)),function(n){const t=r(n,(n=>(m-p-(n.length-1)*h)/o(n,c)));for(const o of n){let n=p;for(const e of o){e.y0=n,e.y1=n+e.value*t,n=e.y1+h;for(const n of e.sourceLinks)n.width=n.value*t}n=(m-n+h)/(o.length+1);for(let t=0;t<o.length;++t){const e=o[t];e.y0+=n*(t+1),e.y1+=n*(t+1)}q(o)}}(t);for(let n=0;n<z;++n){const o=Math.pow(.99,n),e=Math.max(1-o,(n+1)/z);A(t,o,e),_(t,o,e)}}(n),g(n),n}function _(n,t,o){for(let e=1,r=n.length;e<r;++e){const r=n[e];for(const n of r){let o=0,e=0;for(const{source:t,value:r}of n.targetLinks){let s=r*(n.layer-t.layer);o+=B(t,n)*s,e+=s}if(!(e>0))continue;let r=(o/e-n.y0)*t;n.y0+=r,n.y1+=r,W(n)}void 0===y&&r.sort(f),V(r,o)}}function A(n,t,o){for(let e=n.length-2;e>=0;--e){const r=n[e];for(const n of r){let o=0,e=0;for(const{target:t,value:r}of n.sourceLinks){let s=r*(t.layer-n.layer);o+=C(n,t)*s,e+=s}if(!(e>0))continue;let r=(o/e-n.y0)*t;n.y0+=r,n.y1+=r,W(n)}void 0===y&&r.sort(f),V(r,o)}}function V(n,t){const o=n.length>>1,e=n[o];P(n,e.y0-h,o-1,t),I(n,e.y1+h,o+1,t),P(n,m,n.length-1,t),I(n,p,0,t)}function I(n,t,o,e){for(;o<n.length;++o){const r=n[o],s=(t-r.y0)*e;s>1e-6&&(r.y0+=s,r.y1+=s),t=r.y1+h}}function P(n,t,o,e){for(;o>=0;--o){const r=n[o],s=(r.y1-t)*e;s>1e-6&&(r.y0-=s,r.y1-=s),t=r.y0-h}}function W({sourceLinks:n,targetLinks:t}){if(void 0===k){for(const{source:{sourceLinks:n}}of t)n.sort(i);for(const{target:{targetLinks:t}}of n)t.sort(s)}}function q(n){if(void 0===k)for(const{sourceLinks:t,targetLinks:o}of n)t.sort(i),o.sort(s)}function B(n,t){let o=n.y0-(n.sourceLinks.length-1)*h/2;for(const{target:e,width:r}of n.sourceLinks){if(e===t)break;o+=r+h}for(const{source:e,width:r}of t.targetLinks){if(e===n)break;o-=r}return o}function C(n,t){let o=t.y0-(t.targetLinks.length-1)*h/2;for(const{source:e,width:r}of t.targetLinks){if(e===n)break;o+=r+h}for(const{target:e,width:r}of n.sourceLinks){if(e===t)break;o-=r}return o}return E.update=function(n){return g(n),n},E.nodeId=function(n){return arguments.length?(M="function"==typeof n?n:t(n),E):M},E.nodeAlign=function(n){return arguments.length?(S="function"==typeof n?n:t(n),E):S},E.nodeSort=function(n){return arguments.length?(y=n,E):y},E.nodeWidth=function(n){return arguments.length?(x=+n,E):x},E.nodePadding=function(n){return arguments.length?(v=h=+n,E):v},E.nodes=function(n){return arguments.length?(j="function"==typeof n?n:t(n),E):j},E.links=function(n){return arguments.length?(b="function"==typeof n?n:t(n),E):b},E.linkSort=function(n){return arguments.length?(k=n,E):k},E.size=function(n){return arguments.length?(L=p=0,w=+n[0],m=+n[1],E):[w-L,m-p]},E.extent=function(n){return arguments.length?(L=+n[0][0],w=+n[1][0],p=+n[0][1],m=+n[1][1],E):[[L,p],[w,m]]},E.iterations=function(n){return arguments.length?(z=+n,E):z},E}export{h as default};
//# sourceMappingURL=sankey.js.map
