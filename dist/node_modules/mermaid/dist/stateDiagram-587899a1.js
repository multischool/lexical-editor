import{p as t,d as e,s as a}from"./styles-6aaf32cf.js";import"../../d3-transition/src/selection/index.js";import"../../d3-zoom/src/transform.js";import{Graph as i}from"../../dagre-d3-es/src/graphlib/graph.js";import{layout as r}from"../../dagre-d3-es/src/dagre/layout.js";import"../../dagre-d3-es/src/dagre/rank/network-simplex.js";import{c as n,l as s,i as d,e as o,u as g}from"./mermaid-b5860b54.js";import"../../dayjs/dayjs.min.js";import"../../@braintree/sanitize-url/dist/index.js";import"../../dompurify/dist/purify.es.mjs.js";import p from"../../d3-selection/src/select.js";import c from"../../d3-shape/src/line.js";import h from"../../d3-shape/src/curve/basis.js";const l=(t,e)=>{const a=t.append("text").attr("x",2*n().state.padding).attr("y",n().state.textHeight+1.3*n().state.padding).attr("font-size",n().state.fontSize).attr("class","state-title").text(e.descriptions[0]).node().getBBox(),i=a.height,r=t.append("text").attr("x",n().state.padding).attr("y",i+.4*n().state.padding+n().state.dividerMargin+n().state.textHeight).attr("class","state-description");let s=!0,d=!0;e.descriptions.forEach((function(t){s||(!function(t,e,a){const i=t.append("tspan").attr("x",2*n().state.padding).text(e);a||i.attr("dy",n().state.textHeight)}(r,t,d),d=!1),s=!1}));const o=t.append("line").attr("x1",n().state.padding).attr("y1",n().state.padding+i+n().state.dividerMargin/2).attr("y2",n().state.padding+i+n().state.dividerMargin/2).attr("class","descr-divider"),g=r.node().getBBox(),p=Math.max(g.width,a.width);return o.attr("x2",p+3*n().state.padding),t.insert("rect",":first-child").attr("x",n().state.padding).attr("y",n().state.padding).attr("width",p+2*n().state.padding).attr("height",g.height+i+2*n().state.padding).attr("rx",n().state.radius),t},x=(t,e,a)=>{const i=n().state.padding,r=2*n().state.padding,s=t.node().getBBox(),d=s.width,o=s.x,g=t.append("text").attr("x",0).attr("y",n().state.titleShift).attr("font-size",n().state.fontSize).attr("class","state-title").text(e.id),p=g.node().getBBox().width+r;let c,h=Math.max(p,d);h===d&&(h+=r);const l=t.node().getBBox();e.doc,c=o-i,p>d&&(c=(d-h)/2+i),Math.abs(o-l.x)<i&&p>d&&(c=o-(p-d)/2);const x=1-n().state.textHeight;return t.insert("rect",":first-child").attr("x",c).attr("y",x).attr("class",a?"alt-composit":"composit").attr("width",h).attr("height",l.height+n().state.textHeight+n().state.titleShift+1).attr("rx","0"),g.attr("x",c+i),p<=d&&g.attr("x",o+(h-r)/2-p/2+i),t.insert("rect",":first-child").attr("x",c).attr("y",n().state.titleShift-n().state.textHeight-n().state.padding).attr("width",h).attr("height",3*n().state.textHeight).attr("rx",n().state.radius),t.insert("rect",":first-child").attr("x",c).attr("y",n().state.titleShift-n().state.textHeight-n().state.padding).attr("width",h).attr("height",l.height+3+2*n().state.textHeight).attr("rx",n().state.radius),t},f=(t,e)=>{e.attr("class","state-note");const a=e.append("rect").attr("x",0).attr("y",n().state.padding),i=e.append("g"),{textWidth:r,textHeight:s}=((t,e,a,i)=>{let r=0;const s=i.append("text");s.style("text-anchor","start"),s.attr("class","noteText");let d=t.replace(/\r\n/g,"<br/>");d=d.replace(/\n/g,"<br/>");const g=d.split(o.lineBreakRegex);let p=1.25*n().state.noteMargin;for(const t of g){const i=t.trim();if(i.length>0){const t=s.append("tspan");t.text(i),0===p&&(p+=t.node().getBBox().height),r+=p,t.attr("x",e+n().state.noteMargin),t.attr("y",a+r+1.25*n().state.noteMargin)}}return{textWidth:s.node().getBBox().width,textHeight:r}})(t,0,0,i);return a.attr("height",s+2*n().state.noteMargin),a.attr("width",r+2*n().state.noteMargin),a},u=function(t,e){const a=e.id,i={id:a,label:e.id,width:0,height:0},r=t.append("g").attr("id",a).attr("class","stateGroup");"start"===e.type&&(t=>{t.append("circle").attr("class","start-state").attr("r",n().state.sizeUnit).attr("cx",n().state.padding+n().state.sizeUnit).attr("cy",n().state.padding+n().state.sizeUnit)})(r),"end"===e.type&&(t=>{t.append("circle").attr("class","end-state-outer").attr("r",n().state.sizeUnit+n().state.miniPadding).attr("cx",n().state.padding+n().state.sizeUnit+n().state.miniPadding).attr("cy",n().state.padding+n().state.sizeUnit+n().state.miniPadding),t.append("circle").attr("class","end-state-inner").attr("r",n().state.sizeUnit).attr("cx",n().state.padding+n().state.sizeUnit+2).attr("cy",n().state.padding+n().state.sizeUnit+2)})(r),"fork"!==e.type&&"join"!==e.type||((t,e)=>{let a=n().state.forkWidth,i=n().state.forkHeight;if(e.parentId){let t=a;a=i,i=t}t.append("rect").style("stroke","black").style("fill","black").attr("width",a).attr("height",i).attr("x",n().state.padding).attr("y",n().state.padding)})(r,e),"note"===e.type&&f(e.note.text,r),"divider"===e.type&&(t=>{t.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",n().state.textHeight).attr("class","divider").attr("x2",2*n().state.textHeight).attr("y1",0).attr("y2",0)})(r),"default"===e.type&&0===e.descriptions.length&&((t,e)=>{const a=t.append("text").attr("x",2*n().state.padding).attr("y",n().state.textHeight+2*n().state.padding).attr("font-size",n().state.fontSize).attr("class","state-title").text(e.id),i=a.node().getBBox();t.insert("rect",":first-child").attr("x",n().state.padding).attr("y",n().state.padding).attr("width",i.width+2*n().state.padding).attr("height",i.height+2*n().state.padding).attr("rx",n().state.radius)})(r,e),"default"===e.type&&e.descriptions.length>0&&l(r,e);const s=r.node().getBBox();return i.width=s.width+2*n().state.padding,i.height=s.height+2*n().state.padding,i};let y=0;let m;const w={},b=(t,a,d,p,l,f,B)=>{const k=new i({compound:!0,multigraph:!0});let N,E=!0;for(N=0;N<t.length;N++)if("relation"===t[N].stmt){E=!1;break}d?k.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:E?1:m.edgeLengthFactor,nodeSep:E?1:50,isMultiGraph:!0}):k.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:E?1:m.edgeLengthFactor,nodeSep:E?1:50,ranker:"tight-tree",isMultiGraph:!0}),k.setDefaultEdgeLabel((function(){return{}})),B.db.extract(t);const M=B.db.getStates(),v=B.db.getRelations(),z=Object.keys(M);for(const t of z){const e=M[t];let i;if(d&&(e.parentId=d),e.doc){let t=a.append("g").attr("id",e.id).attr("class","stateGroup");i=b(e.doc,t,e.id,!p,l,f,B);{t=x(t,e,p);let a=t.node().getBBox();i.width=a.width,i.height=a.height+m.padding/2,w[e.id]={y:m.compositTitleSize}}}else i=u(a,e);if(e.note){const t={descriptions:[],id:e.id+"-note",note:e.note,type:"note"},r=u(a,t);"left of"===e.note.position?(k.setNode(i.id+"-note",r),k.setNode(i.id,i)):(k.setNode(i.id,i),k.setNode(i.id+"-note",r)),k.setParent(i.id,i.id+"-group"),k.setParent(i.id+"-note",i.id+"-group")}else k.setNode(i.id,i)}s.debug("Count=",k.nodeCount(),k);let S=0;v.forEach((function(t){var e;S++,s.debug("Setting edge",t),k.setEdge(t.id1,t.id2,{relation:t,width:(e=t.title,e?e.length*m.fontSizeFactor:1),height:m.labelHeight*o.getRows(t.title).length,labelpos:"c"},"id"+S)})),r(k),s.debug("Graph after layout",k.nodes());const j=a.node();k.nodes().forEach((function(t){if(void 0!==t&&void 0!==k.node(t)){s.warn("Node "+t+": "+JSON.stringify(k.node(t))),l.select("#"+j.id+" #"+t).attr("transform","translate("+(k.node(t).x-k.node(t).width/2)+","+(k.node(t).y+(w[t]?w[t].y:0)-k.node(t).height/2)+" )"),l.select("#"+j.id+" #"+t).attr("data-x-shift",k.node(t).x-k.node(t).width/2);f.querySelectorAll("#"+j.id+" #"+t+" .divider").forEach((t=>{const e=t.parentElement;let a=0,i=0;e&&(e.parentElement&&(a=e.parentElement.getBBox().width),i=parseInt(e.getAttribute("data-x-shift"),10),Number.isNaN(i)&&(i=0)),t.setAttribute("x1",0-i+8),t.setAttribute("x2",a-i-8)}))}else s.debug("No Node "+t+": "+JSON.stringify(k.node(t)))}));let H=j.getBBox();k.edges().forEach((function(t){void 0!==t&&void 0!==k.edge(t)&&(s.debug("Edge "+t.v+" -> "+t.w+": "+JSON.stringify(k.edge(t))),function(t,a,i){a.points=a.points.filter((t=>!Number.isNaN(t.y)));const r=a.points,d=c().x((function(t){return t.x})).y((function(t){return t.y})).curve(h),p=t.append("path").attr("d",d(r)).attr("id","edge"+y).attr("class","transition");let l="";if(n().state.arrowMarkerAbsolute&&(l=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search,l=l.replace(/\(/g,"\\("),l=l.replace(/\)/g,"\\)")),p.attr("marker-end","url("+l+"#"+function(){switch(e.relationType.DEPENDENCY){case e.relationType.AGGREGATION:return"aggregation";case e.relationType.EXTENSION:return"extension";case e.relationType.COMPOSITION:return"composition";case e.relationType.DEPENDENCY:return"dependency"}}()+"End)"),void 0!==i.title){const e=t.append("g").attr("class","stateLabel"),{x:r,y:d}=g.calcLabelPosition(a.points),p=o.getRows(i.title);let c=0;const h=[];let l=0,x=0;for(let t=0;t<=p.length;t++){const a=e.append("text").attr("text-anchor","middle").text(p[t]).attr("x",r).attr("y",d+c),i=a.node().getBBox();if(l=Math.max(l,i.width),x=Math.min(x,i.x),s.info(i.x,r,d+c),0===c){const t=a.node().getBBox();c=t.height,s.info("Title height",c,d)}h.push(a)}let f=c*p.length;if(p.length>1){const t=(p.length-1)*c*.5;h.forEach(((e,a)=>e.attr("y",d+a*c-t))),f=c*p.length}const u=e.node().getBBox();e.insert("rect",":first-child").attr("class","box").attr("x",r-l/2-n().state.padding/2).attr("y",d-f/2-n().state.padding/2-3.5).attr("width",l+n().state.padding).attr("height",f+n().state.padding),s.info(u)}y++}(a,k.edge(t),k.edge(t).relation))})),H=j.getBBox();const T={id:d||"root",label:d||"root",width:0,height:0};return T.width=H.width+2*m.padding,T.height=H.height+2*m.padding,s.debug("Doc rendered",T,k),T},B={parser:t,db:e,renderer:{setConf:function(){},draw:function(t,e,a,i){m=n().state;const r=n().securityLevel;let o;"sandbox"===r&&(o=p("#i"+e));const g=p("sandbox"===r?o.nodes()[0].contentDocument.body:"body"),c="sandbox"===r?o.nodes()[0].contentDocument:document;s.debug("Rendering diagram "+t);const h=g.select(`[id='${e}']`);h.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z");const l=i.db.getRootDoc();b(l,h,void 0,!1,g,c,i);const x=m.padding,f=h.node().getBBox(),u=f.width+2*x,y=f.height+2*x;d(h,y,1.75*u,m.useMaxWidth),h.attr("viewBox",`${f.x-m.padding}  ${f.y-m.padding} `+u+" "+y)}},styles:a,init:t=>{t.state||(t.state={}),t.state.arrowMarkerAbsolute=t.arrowMarkerAbsolute,e.clear()}};export{B as diagram};
//# sourceMappingURL=stateDiagram-587899a1.js.map
