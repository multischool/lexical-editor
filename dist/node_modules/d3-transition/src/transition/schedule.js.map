{"version":3,"file":"schedule.js","sources":["../../../../../node_modules/d3-transition/src/transition/schedule.js"],"sourcesContent":["import {dispatch} from \"d3-dispatch\";\nimport {timer, timeout} from \"d3-timer\";\n\nvar emptyOn = dispatch(\"start\", \"end\", \"cancel\", \"interrupt\");\nvar emptyTween = [];\n\nexport var CREATED = 0;\nexport var SCHEDULED = 1;\nexport var STARTING = 2;\nexport var STARTED = 3;\nexport var RUNNING = 4;\nexport var ENDING = 5;\nexport var ENDED = 6;\n\nexport default function(node, name, id, index, group, timing) {\n  var schedules = node.__transition;\n  if (!schedules) node.__transition = {};\n  else if (id in schedules) return;\n  create(node, id, {\n    name: name,\n    index: index, // For context during callback.\n    group: group, // For context during callback.\n    on: emptyOn,\n    tween: emptyTween,\n    time: timing.time,\n    delay: timing.delay,\n    duration: timing.duration,\n    ease: timing.ease,\n    timer: null,\n    state: CREATED\n  });\n}\n\nexport function init(node, id) {\n  var schedule = get(node, id);\n  if (schedule.state > CREATED) throw new Error(\"too late; already scheduled\");\n  return schedule;\n}\n\nexport function set(node, id) {\n  var schedule = get(node, id);\n  if (schedule.state > STARTED) throw new Error(\"too late; already running\");\n  return schedule;\n}\n\nexport function get(node, id) {\n  var schedule = node.__transition;\n  if (!schedule || !(schedule = schedule[id])) throw new Error(\"transition not found\");\n  return schedule;\n}\n\nfunction create(node, id, self) {\n  var schedules = node.__transition,\n      tween;\n\n  // Initialize the self timer when the transition is created.\n  // Note the actual delay is not known until the first callback!\n  schedules[id] = self;\n  self.timer = timer(schedule, 0, self.time);\n\n  function schedule(elapsed) {\n    self.state = SCHEDULED;\n    self.timer.restart(start, self.delay, self.time);\n\n    // If the elapsed delay is less than our first sleep, start immediately.\n    if (self.delay <= elapsed) start(elapsed - self.delay);\n  }\n\n  function start(elapsed) {\n    var i, j, n, o;\n\n    // If the state is not SCHEDULED, then we previously errored on start.\n    if (self.state !== SCHEDULED) return stop();\n\n    for (i in schedules) {\n      o = schedules[i];\n      if (o.name !== self.name) continue;\n\n      // While this element already has a starting transition during this frame,\n      // defer starting an interrupting transition until that transition has a\n      // chance to tick (and possibly end); see d3/d3-transition#54!\n      if (o.state === STARTED) return timeout(start);\n\n      // Interrupt the active transition, if any.\n      if (o.state === RUNNING) {\n        o.state = ENDED;\n        o.timer.stop();\n        o.on.call(\"interrupt\", node, node.__data__, o.index, o.group);\n        delete schedules[i];\n      }\n\n      // Cancel any pre-empted transitions.\n      else if (+i < id) {\n        o.state = ENDED;\n        o.timer.stop();\n        o.on.call(\"cancel\", node, node.__data__, o.index, o.group);\n        delete schedules[i];\n      }\n    }\n\n    // Defer the first tick to end of the current frame; see d3/d3#1576.\n    // Note the transition may be canceled after start and before the first tick!\n    // Note this must be scheduled before the start event; see d3/d3-transition#16!\n    // Assuming this is successful, subsequent callbacks go straight to tick.\n    timeout(function() {\n      if (self.state === STARTED) {\n        self.state = RUNNING;\n        self.timer.restart(tick, self.delay, self.time);\n        tick(elapsed);\n      }\n    });\n\n    // Dispatch the start event.\n    // Note this must be done before the tween are initialized.\n    self.state = STARTING;\n    self.on.call(\"start\", node, node.__data__, self.index, self.group);\n    if (self.state !== STARTING) return; // interrupted\n    self.state = STARTED;\n\n    // Initialize the tween, deleting null tween.\n    tween = new Array(n = self.tween.length);\n    for (i = 0, j = -1; i < n; ++i) {\n      if (o = self.tween[i].value.call(node, node.__data__, self.index, self.group)) {\n        tween[++j] = o;\n      }\n    }\n    tween.length = j + 1;\n  }\n\n  function tick(elapsed) {\n    var t = elapsed < self.duration ? self.ease.call(null, elapsed / self.duration) : (self.timer.restart(stop), self.state = ENDING, 1),\n        i = -1,\n        n = tween.length;\n\n    while (++i < n) {\n      tween[i].call(node, t);\n    }\n\n    // Dispatch the end event.\n    if (self.state === ENDING) {\n      self.on.call(\"end\", node, node.__data__, self.index, self.group);\n      stop();\n    }\n  }\n\n  function stop() {\n    self.state = ENDED;\n    self.timer.stop();\n    delete schedules[id];\n    for (var i in schedules) return; // eslint-disable-line no-unused-vars\n    delete node.__transition;\n  }\n}\n"],"names":["emptyOn","dispatch","emptyTween","CREATED","SCHEDULED","STARTING","STARTED","RUNNING","ENDING","ENDED","schedule","node","name","id","index","group","timing","schedules","__transition","self","tween","elapsed","state","timer","restart","start","delay","time","i","j","n","o","stop","timeout","on","call","__data__","tick","Array","length","value","t","duration","ease","create","init","get","Error","set"],"mappings":"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"}