import{Graph as e}from"../graphlib/graph.js";import{addBorderSegments as n}from"./add-border-segments.js";import{adjust as o,undo as t}from"./coordinate-system.js";import{run as i,undo as r}from"./acyclic.js";import{run as a,undo as d}from"./normalize.js";import{rank as s}from"./rank/index.js";import{run as f,cleanup as u}from"./nesting-graph.js";import{order as h}from"./order/index.js";import{parentDummyChains as c}from"./parent-dummy-chains.js";import{position as l}from"./position/index.js";import{time as g,notime as m,asNonCompoundGraph as p,removeEmptyRanks as v,normalizeRanks as b,buildLayerMatrix as x,addDummyNode as y,intersectRect as k}from"./util.js";import w from"../../../lodash-es/mapValues.js";import j from"../../../lodash-es/last.js";import E from"../../../lodash-es/forEach.js";import N from"../../../lodash-es/merge.js";import I from"../../../lodash-es/pick.js";import T from"../../../lodash-es/has.js";import L from"../../../lodash-es/defaults.js";import R from"../../../lodash-es/max.js";function S(w,S){var Y=S&&S.debugTiming?g:m;Y("layout",(function(){var g=Y("  buildLayoutGraph",(function(){return function(n){var o=new e({multigraph:!0,compound:!0}),t=O(n.graph());return o.setGraph(N({},B,V(t,M),I(t,C))),E(n.nodes(),(function(e){var t=O(n.node(e));o.setNode(e,L(V(t,G),P)),o.setParent(e,n.parent(e))})),E(n.edges(),(function(e){var t=O(n.edge(e));o.setEdge(e,N({},_,V(t,z),I(t,F)))})),o}(w)}));Y("  runLayout",(function(){!function(e,g){g("    makeSpaceForEdgeLabels",(function(){!function(e){var n=e.graph();n.ranksep/=2,E(e.edges(),(function(o){var t=e.edge(o);t.minlen*=2,"c"!==t.labelpos.toLowerCase()&&("TB"===n.rankdir||"BT"===n.rankdir?t.width+=t.labeloffset:t.height+=t.labeloffset)}))}(e)})),g("    removeSelfEdges",(function(){!function(e){E(e.edges(),(function(n){if(n.v===n.w){var o=e.node(n.v);o.selfEdges||(o.selfEdges=[]),o.selfEdges.push({e:n,label:e.edge(n)}),e.removeEdge(n)}}))}(e)})),g("    acyclic",(function(){i(e)})),g("    nestingGraph.run",(function(){f(e)})),g("    rank",(function(){s(p(e))})),g("    injectEdgeLabelProxies",(function(){!function(e){E(e.edges(),(function(n){var o=e.edge(n);if(o.width&&o.height){var t=e.node(n.v),i={rank:(e.node(n.w).rank-t.rank)/2+t.rank,e:n};y(e,"edge-proxy",i,"_ep")}}))}(e)})),g("    removeEmptyRanks",(function(){v(e)})),g("    nestingGraph.cleanup",(function(){u(e)})),g("    normalizeRanks",(function(){b(e)})),g("    assignRankMinMax",(function(){!function(e){var n=0;E(e.nodes(),(function(o){var t=e.node(o);t.borderTop&&(t.minRank=e.node(t.borderTop).rank,t.maxRank=e.node(t.borderBottom).rank,n=R(n,t.maxRank))})),e.graph().maxRank=n}(e)})),g("    removeEdgeLabelProxies",(function(){!function(e){E(e.nodes(),(function(n){var o=e.node(n);"edge-proxy"===o.dummy&&(e.edge(o.e).labelRank=o.rank,e.removeNode(n))}))}(e)})),g("    normalize.run",(function(){a(e)})),g("    parentDummyChains",(function(){c(e)})),g("    addBorderSegments",(function(){n(e)})),g("    order",(function(){h(e)})),g("    insertSelfEdges",(function(){!function(e){var n=x(e);E(n,(function(n){var o=0;E(n,(function(n,t){var i=e.node(n);i.order=t+o,E(i.selfEdges,(function(n){y(e,"selfedge",{width:n.label.width,height:n.label.height,rank:i.rank,order:t+ ++o,e:n.e,label:n.label},"_se")})),delete i.selfEdges}))}))}(e)})),g("    adjustCoordinateSystem",(function(){o(e)})),g("    position",(function(){l(e)})),g("    positionSelfEdges",(function(){!function(e){E(e.nodes(),(function(n){var o=e.node(n);if("selfedge"===o.dummy){var t=e.node(o.e.v),i=t.x+t.width/2,r=t.y,a=o.x-i,d=t.height/2;e.setEdge(o.e,o.label),e.removeNode(n),o.label.points=[{x:i+2*a/3,y:r-d},{x:i+5*a/6,y:r-d},{x:i+a,y:r},{x:i+5*a/6,y:r+d},{x:i+2*a/3,y:r+d}],o.label.x=o.x,o.label.y=o.y}}))}(e)})),g("    removeBorderNodes",(function(){!function(e){E(e.nodes(),(function(n){if(e.children(n).length){var o=e.node(n),t=e.node(o.borderTop),i=e.node(o.borderBottom),r=e.node(j(o.borderLeft)),a=e.node(j(o.borderRight));o.width=Math.abs(a.x-r.x),o.height=Math.abs(i.y-t.y),o.x=r.x+o.width/2,o.y=t.y+o.height/2}})),E(e.nodes(),(function(n){"border"===e.node(n).dummy&&e.removeNode(n)}))}(e)})),g("    normalize.undo",(function(){d(e)})),g("    fixupEdgeLabelCoords",(function(){!function(e){E(e.edges(),(function(n){var o=e.edge(n);if(T(o,"x"))switch("l"!==o.labelpos&&"r"!==o.labelpos||(o.width-=o.labeloffset),o.labelpos){case"l":o.x-=o.width/2+o.labeloffset;break;case"r":o.x+=o.width/2+o.labeloffset}}))}(e)})),g("    undoCoordinateSystem",(function(){t(e)})),g("    translateGraph",(function(){!function(e){var n=Number.POSITIVE_INFINITY,o=0,t=Number.POSITIVE_INFINITY,i=0,r=e.graph(),a=r.marginx||0,d=r.marginy||0;function s(e){var r=e.x,a=e.y,d=e.width,s=e.height;n=Math.min(n,r-d/2),o=Math.max(o,r+d/2),t=Math.min(t,a-s/2),i=Math.max(i,a+s/2)}E(e.nodes(),(function(n){s(e.node(n))})),E(e.edges(),(function(n){var o=e.edge(n);T(o,"x")&&s(o)})),n-=a,t-=d,E(e.nodes(),(function(o){var i=e.node(o);i.x-=n,i.y-=t})),E(e.edges(),(function(o){var i=e.edge(o);E(i.points,(function(e){e.x-=n,e.y-=t})),T(i,"x")&&(i.x-=n),T(i,"y")&&(i.y-=t)})),r.width=o-n+a,r.height=i-t+d}(e)})),g("    assignNodeIntersects",(function(){!function(e){E(e.edges(),(function(n){var o,t,i=e.edge(n),r=e.node(n.v),a=e.node(n.w);i.points?(o=i.points[0],t=i.points[i.points.length-1]):(i.points=[],o=a,t=r),i.points.unshift(k(r,o)),i.points.push(k(a,t))}))}(e)})),g("    reversePoints",(function(){!function(e){E(e.edges(),(function(n){var o=e.edge(n);o.reversed&&o.points.reverse()}))}(e)})),g("    acyclic.undo",(function(){r(e)}))}(g,Y)})),Y("  updateInputGraph",(function(){!function(e,n){E(e.nodes(),(function(o){var t=e.node(o),i=n.node(o);t&&(t.x=i.x,t.y=i.y,n.children(o).length&&(t.width=i.width,t.height=i.height))})),E(e.edges(),(function(o){var t=e.edge(o),i=n.edge(o);t.points=i.points,T(i,"x")&&(t.x=i.x,t.y=i.y)})),e.graph().width=n.graph().width,e.graph().height=n.graph().height}(w,g)}))}))}var M=["nodesep","edgesep","ranksep","marginx","marginy"],B={ranksep:50,edgesep:20,nodesep:50,rankdir:"tb"},C=["acyclicer","ranker","rankdir","align"],G=["width","height"],P={width:0,height:0},z=["minlen","weight","width","height","labeloffset"],_={minlen:1,weight:1,width:0,height:0,labeloffset:10,labelpos:"r"},F=["labelpos"];function V(e,n){return w(I(e,n),Number)}function O(e){var n={};return E(e,(function(e,o){n[o.toLowerCase()]=e})),n}export{S as layout};
//# sourceMappingURL=layout.js.map
