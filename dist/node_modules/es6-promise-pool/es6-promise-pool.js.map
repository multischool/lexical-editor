{"version":3,"file":"es6-promise-pool.js","sources":["../../../node_modules/es6-promise-pool/es6-promise-pool.js"],"sourcesContent":["(function (root, factory) {\n  /* istanbul ignore next */\n  if (typeof define === 'function' && define.amd) {\n    define([], factory)\n  } else if (typeof exports === 'object') {\n    module.exports = factory()\n  } else {\n    root.PromisePool = factory()\n    // Legacy API\n    root.promisePool = root.PromisePool\n  }\n})(this, function () {\n  'use strict'\n\n  var EventTarget = function () {\n    this._listeners = {}\n  }\n\n  EventTarget.prototype.addEventListener = function (type, listener) {\n    this._listeners[type] = this._listeners[type] || []\n    if (this._listeners[type].indexOf(listener) < 0) {\n      this._listeners[type].push(listener)\n    }\n  }\n\n  EventTarget.prototype.removeEventListener = function (type, listener) {\n    if (this._listeners[type]) {\n      var p = this._listeners[type].indexOf(listener)\n      if (p >= 0) {\n        this._listeners[type].splice(p, 1)\n      }\n    }\n  }\n\n  EventTarget.prototype.dispatchEvent = function (evt) {\n    if (this._listeners[evt.type] && this._listeners[evt.type].length) {\n      var listeners = this._listeners[evt.type].slice()\n      for (var i = 0, l = listeners.length; i < l; ++i) {\n        listeners[i].call(this, evt)\n      }\n    }\n  }\n\n  var isGenerator = function (func) {\n    return (typeof func.constructor === 'function' &&\n      func.constructor.name === 'GeneratorFunction')\n  }\n\n  var functionToIterator = function (func) {\n    return {\n      next: function () {\n        var promise = func()\n        return promise ? {value: promise} : {done: true}\n      }\n    }\n  }\n\n  var promiseToIterator = function (promise) {\n    var called = false\n    return {\n      next: function () {\n        if (called) {\n          return {done: true}\n        }\n        called = true\n        return {value: promise}\n      }\n    }\n  }\n\n  var toIterator = function (obj, Promise) {\n    var type = typeof obj\n    if (type === 'object') {\n      if (typeof obj.next === 'function') {\n        return obj\n      }\n      /* istanbul ignore else */\n      if (typeof obj.then === 'function') {\n        return promiseToIterator(obj)\n      }\n    }\n    if (type === 'function') {\n      return isGenerator(obj) ? obj() : functionToIterator(obj)\n    }\n    return promiseToIterator(Promise.resolve(obj))\n  }\n\n  var PromisePoolEvent = function (target, type, data) {\n    this.target = target\n    this.type = type\n    this.data = data\n  }\n\n  var PromisePool = function (source, concurrency, options) {\n    EventTarget.call(this)\n    if (typeof concurrency !== 'number' ||\n        Math.floor(concurrency) !== concurrency ||\n        concurrency < 1) {\n      throw new Error('Invalid concurrency')\n    }\n    this._concurrency = concurrency\n    this._options = options || {}\n    this._options.promise = this._options.promise || Promise\n    this._iterator = toIterator(source, this._options.promise)\n    this._done = false\n    this._size = 0\n    this._promise = null\n    this._callbacks = null\n  }\n  PromisePool.prototype = new EventTarget()\n  PromisePool.prototype.constructor = PromisePool\n\n  PromisePool.prototype.concurrency = function (value) {\n    if (typeof value !== 'undefined') {\n      this._concurrency = value\n      if (this.active()) {\n        this._proceed()\n      }\n    }\n    return this._concurrency\n  }\n\n  PromisePool.prototype.size = function () {\n    return this._size\n  }\n\n  PromisePool.prototype.active = function () {\n    return !!this._promise\n  }\n\n  PromisePool.prototype.promise = function () {\n    return this._promise\n  }\n\n  PromisePool.prototype.start = function () {\n    var that = this\n    var Promise = this._options.promise\n    this._promise = new Promise(function (resolve, reject) {\n      that._callbacks = {\n        reject: reject,\n        resolve: resolve\n      }\n      that._proceed()\n    })\n    return this._promise\n  }\n\n  PromisePool.prototype._fireEvent = function (type, data) {\n    this.dispatchEvent(new PromisePoolEvent(this, type, data))\n  }\n\n  PromisePool.prototype._settle = function (error) {\n    if (error) {\n      this._callbacks.reject(error)\n    } else {\n      this._callbacks.resolve()\n    }\n    this._promise = null\n    this._callbacks = null\n  }\n\n  PromisePool.prototype._onPooledPromiseFulfilled = function (promise, result) {\n    this._size--\n    if (this.active()) {\n      this._fireEvent('fulfilled', {\n        promise: promise,\n        result: result\n      })\n      this._proceed()\n    }\n  }\n\n  PromisePool.prototype._onPooledPromiseRejected = function (promise, error) {\n    this._size--\n    if (this.active()) {\n      this._fireEvent('rejected', {\n        promise: promise,\n        error: error\n      })\n      this._settle(error || new Error('Unknown error'))\n    }\n  }\n\n  PromisePool.prototype._trackPromise = function (promise) {\n    var that = this\n    promise\n      .then(function (result) {\n        that._onPooledPromiseFulfilled(promise, result)\n      }, function (error) {\n        that._onPooledPromiseRejected(promise, error)\n      })['catch'](function (err) {\n        that._settle(new Error('Promise processing failed: ' + err))\n      })\n  }\n\n  PromisePool.prototype._proceed = function () {\n    if (!this._done) {\n      var result = { done: false }\n      while (this._size < this._concurrency &&\n          !(result = this._iterator.next()).done) {\n        this._size++\n        this._trackPromise(result.value)\n      }\n      this._done = (result === null || !!result.done)\n    }\n    if (this._done && this._size === 0) {\n      this._settle()\n    }\n  }\n\n  PromisePool.PromisePoolEvent = PromisePoolEvent\n  // Legacy API\n  PromisePool.PromisePool = PromisePool\n\n  return PromisePool\n})\n"],"names":["exports","EventTarget","this","_listeners","prototype","addEventListener","type","listener","indexOf","push","removeEventListener","p","splice","dispatchEvent","evt","length","listeners","slice","i","l","call","isGenerator","func","constructor","name","functionToIterator","next","promise","value","done","promiseToIterator","called","toIterator","obj","Promise","then","resolve","PromisePoolEvent","target","data","PromisePool","source","concurrency","options","Math","floor","Error","_concurrency","_options","_iterator","_done","_size","_promise","_callbacks","active","_proceed","size","start","that","reject","_fireEvent","_settle","error","_onPooledPromiseFulfilled","result","_onPooledPromiseRejected","_trackPromise","err","factory"],"mappings":"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"}