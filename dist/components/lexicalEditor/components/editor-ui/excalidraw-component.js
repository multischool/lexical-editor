import*as e from"react";import{useState as t,useRef as n,useCallback as i,useEffect as o,useMemo as r}from"react";import{useLexicalComposerContext as a}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{useLexicalEditable as l}from"../../../../node_modules/@lexical/react/useLexicalEditable.mjs.js";import{useLexicalNodeSelection as m}from"../../../../node_modules/@lexical/react/useLexicalNodeSelection.mjs.js";import{mergeRegister as s}from"@lexical/utils";import{$getNodeByKey as u,CLICK_COMMAND as c,COMMAND_PRIORITY_LOW as f,KEY_DELETE_COMMAND as d,KEY_BACKSPACE_COMMAND as p}from"lexical";import{$isExcalidrawNode as g}from"../nodes/excalidraw-node.js";import v from"./excalidraw-image.js";import{ExcalidrawModal as h}from"./excalidraw-modal.js";import{ImageResizer as x}from"./image-resizer.js";function b(b){var j=b.nodeKey,C=b.data,E=b.width,S=b.height,w=a()[0],N=l(),y=t("[]"===C&&w.isEditable()),D=y[0],O=y[1],R=n(null),k=n(null),z=n(null),L=m(j),_=L[0],F=L[1],J=L[2],K=t(!1),A=K[0],H=K[1],I=i((function(e){return _&&(e.preventDefault(),w.update((function(){var e=u(j);e&&e.remove()}))),!1}),[w,_,j]);o((function(){if(N)return s(w.registerCommand(c,(function(e){var t=k.current,n=e.target;return!!A||!(null===t||!t.contains(n))&&(e.shiftKey||J(),F(!_),e.detail>1&&O(!0),!0)}),f),w.registerCommand(d,I,f),w.registerCommand(p,I,f));_&&J()}),[J,w,_,A,I,F,N]);var M=i((function(){return O(!1),w.update((function(){var e=u(j);e&&e.remove()}))}),[w,j]),T=i((function(){O(!0)}),[]),W=r((function(){return JSON.parse(C)}),[C]),q=W.elements,B=void 0===q?[]:q,G=W.files,P=void 0===G?{}:G,Q=W.appState,U=void 0===Q?{}:Q,V=i((function(){O(!1),0===B.length&&w.update((function(){var e=u(j);e&&e.remove()}))}),[w,j,B.length]);return e.createElement(e.Fragment,null,N&&D&&e.createElement(h,{initialElements:B,initialFiles:P,initialAppState:U,isShown:D,onDelete:M,onClose:V,onSave:function(e,t,n){!function(e,t,n){w.update((function(){var i=u(j);g(i)&&(e&&e.length>0||Object.keys(n).length>0?i.setData(JSON.stringify({appState:t,elements:e,files:n})):i.remove())}))}(e,t,n),O(!1)},closeOnClickOutside:!1}),B.length>0&&e.createElement("button",{ref:k,className:"m-0 border-0 bg-transparent p-0 ".concat(_?"user-select-none ring-2 ring-primary ring-offset-2":"")},e.createElement(v,{imageContainerRef:R,className:"image",elements:B,files:P,appState:U,width:E,height:S}),_&&N&&e.createElement("div",{className:"image-edit-button",role:"button",tabIndex:0,onMouseDown:function(e){return e.preventDefault()},onClick:T}),(_||A)&&N&&e.createElement(x,{buttonRef:z,showCaption:!0,setShowCaption:function(){return null},imageRef:R,editor:w,onResizeStart:function(){H(!0)},onResizeEnd:function(e,t){setTimeout((function(){H(!1)}),200),w.update((function(){var n=u(j);g(n)&&(n.setWidth(e),n.setHeight(t))}))},captionsEnabled:!0})))}export{b as default};
//# sourceMappingURL=excalidraw-component.js.map
