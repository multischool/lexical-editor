import*as e from"react";import{useRef as t,useState as r,useCallback as n,useEffect as o,Suspense as a}from"react";import{AutoFocusPlugin as i}from"../../../../node_modules/@lexical/react/LexicalAutoFocusPlugin.mjs.js";import{useCollaborationContext as l}from"../../../../node_modules/@lexical/react/LexicalCollaborationContext.mjs.js";import{useLexicalComposerContext as c}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{LexicalErrorBoundary as m}from"../../../../node_modules/@lexical/react/LexicalErrorBoundary.mjs.js";import{HistoryPlugin as s}from"../../../../node_modules/@lexical/react/LexicalHistoryPlugin.mjs.js";import{LexicalNestedComposer as u}from"../../../../node_modules/@lexical/react/LexicalNestedComposer.mjs.js";import{RichTextPlugin as d}from"../../../../node_modules/@lexical/react/LexicalRichTextPlugin.mjs.js";import{useLexicalEditable as f}from"../../../../node_modules/@lexical/react/useLexicalEditable.mjs.js";import{useLexicalNodeSelection as g}from"../../../../node_modules/@lexical/react/useLexicalNodeSelection.mjs.js";import{mergeRegister as p}from"@lexical/utils";import{$getSelection as h,$isNodeSelection as x,$setSelection as E,$isRangeSelection as v,SELECTION_CHANGE_COMMAND as b,COMMAND_PRIORITY_LOW as w,CLICK_COMMAND as C,DRAGSTART_COMMAND as j,KEY_DELETE_COMMAND as N,KEY_BACKSPACE_COMMAND as _,KEY_ENTER_COMMAND as L,KEY_ESCAPE_COMMAND as y,RootNode as R,TextNode as I,ParagraphNode as S,createCommand as k,$getNodeByKey as T}from"lexical";import{$isImageNode as W}from"../nodes/image-node.js";import{ContentEditable as z}from"./content-editable.js";import{ImageResizer as A}from"./image-resizer.js";var D=new Set,M=k("RIGHT_CLICK_IMAGE_COMMAND");function P(t){var r=t.altText,n=t.className,o=t.imageRef,a=t.src,i=t.width,l=t.height,c=t.maxWidth,m=t.onError;return function(e){if(!D.has(e))throw new Promise((function(t){var r=new Image;r.src=e,r.onload=function(){D.add(e),t(null)},r.onerror=function(){D.add(e)}}))}(a),e.createElement("img",{className:n||void 0,src:a,alt:r,ref:o,style:{height:l,maxWidth:c,width:i},onError:m,draggable:"false"})}function G(){return e.createElement("img",{src:"",style:{height:200,opacity:.2,width:200},draggable:"false"})}function H(k){var D=k.src,H=k.altText,K=k.nodeKey,B=k.width,F=k.height,O=k.maxWidth,U=k.resizable,q=k.showCaption,J=k.caption,Q=k.captionsEnabled,V=t(null),X=t(null),Y=g(K),Z=Y[0],$=Y[1],ee=Y[2],te=r(!1),re=te[0],ne=te[1];l().isCollabActive;var oe=c()[0],ae=r(null),ie=ae[0],le=ae[1],ce=t(null),me=r(!1),se=me[0],ue=me[1],de=f(),fe=n((function(e){var t=h();Z&&x(t)&&(e.preventDefault(),oe.update((function(){t.getNodes().forEach((function(e){W(e)&&e.remove()}))})));return!1}),[oe,Z]),ge=n((function(e){var t=h(),r=X.current;if(Z&&x(t)&&1===t.getNodes().length){if(q)return E(null),e.preventDefault(),J.focus(),!0;if(null!==r&&r!==document.activeElement)return e.preventDefault(),r.focus(),!0}return!1}),[J,Z,q]),pe=n((function(e){return(ce.current===J||X.current===e.target)&&(E(null),oe.update((function(){$(!0);var e=oe.getRootElement();null!==e&&e.focus()})),!0)}),[J,oe,$]),he=n((function(e){var t=e;return!!re||t.target===V.current&&(t.shiftKey?$(!Z):(ee(),$(!0)),!0)}),[re,Z,$,ee]),xe=n((function(e){oe.getEditorState().read((function(){var t=h();"IMG"===e.target.tagName&&v(t)&&1===t.getNodes().length&&oe.dispatchCommand(M,e)}))}),[oe]);o((function(){var e=!0,t=oe.getRootElement(),r=p(oe.registerUpdateListener((function(t){var r=t.editorState;e&&le(r.read((function(){return h()})))})),oe.registerCommand(b,(function(e,t){return ce.current=t,!1}),w),oe.registerCommand(C,he,w),oe.registerCommand(M,he,w),oe.registerCommand(j,(function(e){return e.target===V.current&&(e.preventDefault(),!0)}),w),oe.registerCommand(N,fe,w),oe.registerCommand(_,fe,w),oe.registerCommand(L,ge,w),oe.registerCommand(y,pe,w));return null==t||t.addEventListener("contextmenu",xe),function(){e=!1,r(),null==t||t.removeEventListener("contextmenu",xe)}}),[ee,oe,re,Z,K,fe,ge,pe,he,xe,$]);var Ee=Z&&x(ie)&&!re,ve=(Z||re)&&de;return e.createElement(a,{fallback:null},e.createElement(e.Fragment,null,e.createElement("div",{draggable:Ee},se?e.createElement(G,null):e.createElement(P,{className:"max-w-full cursor-default ".concat(ve?"".concat(x(ie)?"draggable cursor-grab active:cursor-grabbing":""," focused ring-2 ring-primary ring-offset-2"):null),src:D,altText:H,imageRef:V,width:B,height:F,maxWidth:O,onError:function(){return ue(!0)}})),q&&e.createElement("div",{className:"image-caption-container absolute bottom-1 left-0 right-0 m-0 block min-w-[100px] overflow-hidden border-t bg-white/90 p-0"},e.createElement(u,{initialEditor:J,initialNodes:[R,I,S]},e.createElement(i,null),e.createElement(s,null),e.createElement(d,{contentEditable:e.createElement(z,{className:"ImageNode__contentEditable user-select-text word-break-break-word relative block min-h-5 w-[calc(100%-20px)] cursor-text resize-none whitespace-pre-wrap border-0 p-2.5 text-sm caret-primary outline-none",placeholderClassName:"ImageNode__placeholder text-sm text-muted-foreground overflow-hidden absolute top-2.5 left-2.5 pointer-events-none text-ellipsis user-select-none whitespace-nowrap inline-block",placeholder:"Enter a caption..."}),ErrorBoundary:m}))),U&&x(ie)&&ve&&e.createElement(A,{showCaption:q,setShowCaption:function(){oe.update((function(){var e=T(K);W(e)&&e.setShowCaption(!0)}))},editor:oe,buttonRef:X,imageRef:V,maxWidth:O,onResizeStart:function(){ne(!0)},onResizeEnd:function(e,t){setTimeout((function(){ne(!1)}),200),oe.update((function(){var r=T(K);W(r)&&r.setWidthAndHeight(e,t)}))},captionsEnabled:!se&&Q})))}export{M as RIGHT_CLICK_IMAGE_COMMAND,H as default};
//# sourceMappingURL=image-component.js.map
