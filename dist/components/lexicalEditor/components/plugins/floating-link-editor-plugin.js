import*as e from"react";import{useState as t,useEffect as n,useRef as r,useCallback as i}from"react";import{$isLinkNode as o,TOGGLE_LINK_COMMAND as l,$isAutoLinkNode as a,$createLinkNode as s}from"@lexical/link";import{useLexicalComposerContext as c}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{mergeRegister as m,$findMatchingParent as u}from"@lexical/utils";import{SELECTION_CHANGE_COMMAND as d,COMMAND_PRIORITY_CRITICAL as f,CLICK_COMMAND as p,$getSelection as v,$isRangeSelection as E,COMMAND_PRIORITY_LOW as g,KEY_ESCAPE_COMMAND as k,COMMAND_PRIORITY_HIGH as h,$isLineBreakNode as w}from"lexical";import{createPortal as L}from"react-dom";import{Button as x}from"../../ui/button.js";import{Input as N}from"../../ui/input.js";import{useFloatingLinkContext as C}from"../context/floating-link-context.js";import{getSelectedNode as j}from"../utils/get-selected-node.js";import{setFloatingElemPositionForLinkEditor as _}from"../utils/set-floating-elem-position-for-link-editor.js";import{sanitizeUrl as b}from"../utils/url.js";import y from"../../../../node_modules/lucide-react/dist/esm/icons/x.js";import U from"../../../../node_modules/lucide-react/dist/esm/icons/check.js";import z from"../../../../node_modules/lucide-react/dist/esm/icons/pencil.js";import I from"../../../../node_modules/lucide-react/dist/esm/icons/trash.js";function M(c){var f=c.editor,p=c.isLink,w=c.setIsLink,L=c.anchorElem,C=c.isLinkEditMode,M=c.setIsLinkEditMode,R=r(null),S=r(null),D=t(""),K=D[0],B=D[1],P=t("https://"),q=P[0],A=P[1],F=t(null),G=F[0],H=F[1],J=i((function(){var e,t,n=v();if(E(n)){var r=j(n),i=u(r,o);i?B(i.getURL()):o(r)?B(r.getURL()):B(""),C&&A(K)}var l=R.current,a=window.getSelection(),s=document.activeElement;if(null!==l){var c=f.getRootElement();if(null!==n&&null!==a&&null!==c&&c.contains(a.anchorNode)&&f.isEditable()){var m=null===(t=null===(e=a.focusNode)||void 0===e?void 0:e.parentElement)||void 0===t?void 0:t.getBoundingClientRect();m&&(m.y+=40,_(m,l,L)),H(n)}else s&&"link-input"===s.className||(null!==c&&_(null,l,L),H(null),M(!1),B(""));return!0}}),[L,f,M,C,K]);n((function(){var e=L.parentElement,t=function(){f.getEditorState().read((function(){J()}))};return window.addEventListener("resize",t),e&&e.addEventListener("scroll",t),function(){window.removeEventListener("resize",t),e&&e.removeEventListener("scroll",t)}}),[L.parentElement,f,J]),n((function(){return m(f.registerUpdateListener((function(e){e.editorState.read((function(){J()}))})),f.registerCommand(d,(function(){return J(),!0}),g),f.registerCommand(k,(function(){return!!p&&(w(!1),!0)}),h))}),[f,J,w,p]),n((function(){f.getEditorState().read((function(){J()}))}),[f,J]),n((function(){C&&S.current&&(S.current.focus(),w(!0))}),[C,p]);var O=function(){null!==G&&(""!==K&&(f.dispatchCommand(l,b(q)),f.update((function(){var e=v();if(E(e)){var t=j(e).getParent();if(a(t)){var n=s(t.getURL(),{rel:t.__rel,target:t.__target,title:t.__title});t.replace(n,!0)}}}))),A("https://"),M(!1))};return e.createElement("div",{ref:R,className:"absolute left-0 top-0 w-full max-w-sm rounded-md opacity-0 shadow-md"},p?C?e.createElement("div",{className:"flex items-center space-x-2 rounded-md border p-1 pl-2"},e.createElement(N,{ref:S,value:q,onChange:function(e){return A(e.target.value)},onKeyDown:function(e){"Enter"===e.key?(e.preventDefault(),O()):"Escape"===e.key&&(e.preventDefault(),M(!1))},className:"flex-grow"}),e.createElement(x,{size:"icon",variant:"ghost",onClick:function(){M(!1),w(!1)},className:"shrink-0"},e.createElement(y,{className:"h-4 w-4"})),e.createElement(x,{size:"icon",onClick:O,className:"shrink-0"},e.createElement(U,{className:"h-4 w-4"}))):e.createElement("div",{className:"flex items-center justify-between rounded-md border p-1 pl-2"},e.createElement("a",{href:b(K),target:"_blank",rel:"noopener noreferrer",className:"overflow-hidden text-ellipsis whitespace-nowrap text-sm"},K),e.createElement("div",{className:"flex"},e.createElement(x,{size:"icon",variant:"ghost",onClick:function(){A(K),M(!0)}},e.createElement(z,{className:"h-4 w-4"})),e.createElement(x,{size:"icon",variant:"destructive",onClick:function(){f.dispatchCommand(l,null)}},e.createElement(I,{className:"h-4 w-4"})))):null)}function R(r){var i=r.anchorElem,l=c()[0],s=C();return function(r,i,l,s){var c=t(r),k=c[0],h=c[1],x=t(!1),N=x[0],C=x[1];return n((function(){function e(){var e=v();if(E(e)){var t=j(e),n=u(t,o),r=u(t,a);if(!n&&!r)return void C(!1);var i=e.getNodes().filter((function(e){return!w(e)})).find((function(e){var t=u(e,o),i=u(e,a);return n&&!n.is(t)||t&&!t.is(n)||r&&!r.is(i)||i&&(!i.is(r)||i.getIsUnlinked())}));C(!i)}}return m(r.registerUpdateListener((function(t){t.editorState.read((function(){e()}))})),r.registerCommand(d,(function(t,n){return e(),h(n),!1}),f),r.registerCommand(p,(function(e){var t=v();if(E(t)){var n=j(t),r=u(n,o);if(o(r)&&(e.metaKey||e.ctrlKey))return window.open(r.getURL(),"_blank"),!0}return!1}),g))}),[r]),i?L(e.createElement(M,{editor:k,isLink:N,anchorElem:i,setIsLink:C,isLinkEditMode:l,setIsLinkEditMode:s}),i):null}(l,i,s.isLinkEditMode,s.setIsLinkEditMode)}export{R as FloatingLinkEditorPlugin};
//# sourceMappingURL=floating-link-editor-plugin.js.map
