import{__spreadArray as e}from"../../../../node_modules/tslib/tslib.es6.mjs.js";import*as t from"react";import{useState as n,useEffect as r,useMemo as o,useRef as l,useCallback as i}from"react";import{useLexicalComposerContext as u}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{useLexicalEditable as a}from"../../../../node_modules/@lexical/react/useLexicalEditable.mjs.js";import{TableNode as c,$isTableCellNode as f,$getTableNodeFromLexicalNodeOrThrow as s,$getTableRowIndexFromTableCellNode as d,$isTableRowNode as m,$computeTableMapSkipCellCheck as p,getDOMCellFromTarget as v}from"@lexical/table";import{calculateZoomLevel as w}from"@lexical/utils";import{$getNearestNodeFromDOMNode as g}from"lexical";import{createPortal as h}from"react-dom";function x(o){var u=o.editor,a=l(null),h=l(null),x=l(null),b=l(null),E=n(null),C=E[0],T=E[1],y=n(null),R=y[0],z=y[1],L=n(!1),O=L[0],X=L[1],Y=n(null),_=Y[0],j=Y[1],M=i((function(){z(null),a.current=null,j(null),b.current=null,x.current=null}),[]);r((function(){return u.registerNodeTransform(c,(function(e){if(e.getColWidths())return e;var t=e.getColumnCount();return e.setColWidths(Array(t).fill(92)),e}))}),[u]),r((function(){var e=function(e){setTimeout((function(){var t=e.target;if(_)T({x:e.clientX,y:e.clientY});else if(X(function(e){return!(1&~e.buttons)}(e)),!(h.current&&h.current.contains(t)||a.current===t)){a.current=t;var n=v(t);n&&R!==n?u.update((function(){var e=g(n.elem);if(!e)throw new Error("TableCellResizer: Table cell node not found.");var r=s(e),o=u.getElementByKey(r.getKey());if(!o)throw new Error("TableCellResizer: Table element not found.");a.current=t,x.current=o.getBoundingClientRect(),z(n)})):null==n&&M()}}),0)},t=function(e){setTimeout((function(){X(!0)}),0)},n=function(e){setTimeout((function(){X(!1)}),0)},r=u.registerRootListener((function(r,o){null==o||o.removeEventListener("mousemove",e),null==o||o.removeEventListener("mousedown",t),null==o||o.removeEventListener("mouseup",n),null==r||r.addEventListener("mousemove",e),null==r||r.addEventListener("mousedown",t),null==r||r.addEventListener("mouseup",n)}));return function(){r()}}),[R,_,u,M]);var k=function(e){return"bottom"===e},B=i((function(e){if(!R)throw new Error("TableCellResizer: Expected active cell.");u.update((function(){var t=g(R.elem);if(!f(t))throw new Error("TableCellResizer: Table cell node not found.");var n=s(t),r=d(t)+t.getRowSpan()-1,o=n.getChildren();if(r>=o.length||r<0)throw new Error("Expected table cell to be inside of table row.");var l=o[r];if(!m(l))throw new Error("Expected table row");var i=l.getHeight();if(void 0===i){var a=l.getChildren();i=Math.min.apply(Math,a.map((function(e){var t;return null!==(t=D(e,u))&&void 0!==t?t:1/0})))}var c=Math.max(i+e,33);l.setHeight(c)}),{tag:"skip-scroll-into-view"})}),[R,u]),D=function(e,t){var n=t.getElementByKey(e.getKey());return null==n?void 0:n.clientHeight},K=i((function(t){if(!R)throw new Error("TableCellResizer: Expected active cell.");u.update((function(){var n=g(R.elem);if(!f(n))throw new Error("TableCellResizer: Table cell node not found.");var r=s(n),o=function(e,t){for(var n=0;n<t.length;n++)for(var r=0;r<t[n].length;r++)if(t[n][r].cell===e)return r}(n,p(r,null,null)[0]);if(void 0===o)throw new Error("TableCellResizer: Table column not found.");var l=r.getColWidths();if(l){var i=l[o];if(void 0!==i){var u=e([],l,!0),a=Math.max(i+t,92);u[o]=a,r.setColWidths(u)}}}),{tag:"skip-scroll-into-view"})}),[R,u]),W=i((function(e){var t=function(n){if(n.preventDefault(),n.stopPropagation(),!R)throw new Error("TableCellResizer: Expected active cell.");if(b.current){var r=b.current,o=r.x,l=r.y;if(null===R)return;var i=w(n.target);if(k(e)){var u=(n.clientY-l)/i;B(u)}else{var a=(n.clientX-o)/i;K(a)}M(),document.removeEventListener("mouseup",t)}};return t}),[R,M,K,B]),H=i((function(e){return function(t){if(t.preventDefault(),t.stopPropagation(),!R)throw new Error("TableCellResizer: Expected active cell.");b.current={x:t.clientX,y:t.clientY},T(b.current),j(e),document.addEventListener("mouseup",W(e))}}),[R,W]),N=i((function(){if(R){var e=R.elem.getBoundingClientRect(),t=e.height,n=e.width,r=e.top,o=e.left,l=w(R.elem),i={bottom:{backgroundColor:"none",cursor:"row-resize",height:"".concat(10,"px"),left:"".concat(window.pageXOffset+o,"px"),top:"".concat(window.pageYOffset+r+t-5,"px"),width:"".concat(n,"px")},right:{backgroundColor:"none",cursor:"col-resize",height:"".concat(t,"px"),left:"".concat(window.pageXOffset+o+n-5,"px"),top:"".concat(window.pageYOffset+r,"px"),width:"".concat(10,"px")}},u=x.current;return _&&C&&u&&(k(_)?(i[_].left="".concat(window.pageXOffset+u.left,"px"),i[_].top="".concat(window.pageYOffset+C.y/l,"px"),i[_].height="3px",i[_].width="".concat(u.width,"px")):(i[_].top="".concat(window.pageYOffset+u.top,"px"),i[_].left="".concat(window.pageXOffset+C.x/l,"px"),i[_].width="3px",i[_].height="".concat(u.height,"px")),i[_].backgroundColor="#adf"),i}return{bottom:null,left:null,right:null,top:null}}),[R,_,C]),P=N();return t.createElement("div",{ref:h},null!=R&&!O&&t.createElement(t.Fragment,null,t.createElement("div",{className:"TableCellResizer__ui absolute",style:P.right||void 0,onMouseDown:H("right")}),t.createElement("div",{className:"TableCellResizer__ui absolute",style:P.bottom||void 0,onMouseDown:H("bottom")})))}function b(){var e=u()[0],l=a(),i=n(null),c=i[0],f=i[1];return r((function(){f(document.body)}),[]),o((function(){return l&&c?h(t.createElement(x,{editor:e}),c):null}),[e,l,c])}export{b as TableCellResizerPlugin};
//# sourceMappingURL=table-cell-resizer-plugin.js.map
