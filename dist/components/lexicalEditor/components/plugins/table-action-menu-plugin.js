import*as e from"react";import{useRef as t,useState as n,useCallback as r,useEffect as o}from"react";import{useLexicalComposerContext as l}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{useLexicalEditable as c}from"../../../../node_modules/@lexical/react/useLexicalEditable.mjs.js";import{$getTableCellNodeFromLexicalNode as i,TableCellNode as a,$isTableSelection as u,$getTableNodeFromLexicalNodeOrThrow as s,getTableObserverFromTableElement as f,$insertTableRow__EXPERIMENTAL as m,$insertTableColumn__EXPERIMENTAL as d,$deleteTableRow__EXPERIMENTAL as g,$deleteTableColumn__EXPERIMENTAL as p,$getTableRowIndexFromTableCellNode as h,$isTableRowNode as w,TableCellHeaderStates as E,$isTableCellNode as v,$getTableColumnIndexFromTableCellNode as C,$getNodeTriplet as S,$unmergeCell as y}from"@lexical/table";import{$getSelection as b,$isRangeSelection as x,$getRoot as R,$isParagraphNode as N,$createParagraphNode as O,$isTextNode as M,$isElementNode as k}from"lexical";import{createPortal as B}from"react-dom";import{Command as L,CommandList as j,CommandGroup as _,CommandItem as I,CommandSeparator as K}from"../../ui/command.js";import{Popover as D,PopoverTrigger as H,PopoverContent as U}from"../../ui/popover.js";import{useEditorModal as W}from"../editor-hooks/use-modal.js";import z from"../editor-ui/colorpicker.js";import A from"../../../../node_modules/lucide-react/dist/esm/icons/chevron-down.js";import X from"../../../../node_modules/lucide-react/dist/esm/icons/paint-bucket.js";function Y(e){var t=e.getShape();return{columns:t.toX-t.fromX+1,rows:t.toY-t.fromY+1}}function F(e){if(1!==e.getChildrenSize())return!1;var t=e.getFirstChildOrThrow();return!(!N(t)||!t.isEmpty())}function T(e){return e.getEditorState().read((function(){var e=b();if(x(e)||u(e)){var t=S(e.anchor)[0];if(v(t))return t.getBackgroundColor()}return null}))}function P(c){var i=c.onClose,B=c.tableCellNode,D=c.setIsMenuOpen,H=c.contextRef,U=c.cellMerge,A=l()[0],P=t(null),$=n(B),q=$[0],G=$[1],J=n({columns:1,rows:1}),Q=J[0],V=J[1],Z=W()[0],ee=n(!1),te=ee[0],ne=ee[1],re=n(!1),oe=re[0],le=re[1],ce=n((function(){return T(A)||""})),ie=ce[0],ae=ce[1];o((function(){return A.registerMutationListener(a,(function(e){"updated"===e.get(q.getKey())&&(A.getEditorState().read((function(){G(q.getLatest())})),ae(T(A)||""))}),{skipInitialization:!0})}),[A,q]),o((function(){A.getEditorState().read((function(){var e=b();if(u(e)){var t=Y(e);V(Y(e)),ne(t.columns>1||t.rows>1)}le(function(){var e=b();if(x(e)&&!e.isCollapsed()||u(e)&&!e.anchor.is(e.focus)||!x(e)&&!u(e))return!1;var t=S(e.anchor)[0];return t.__colSpan>1||t.__rowSpan>1}())}))}),[A]),o((function(){var e=H.current,t=P.current,n=A.getRootElement();if(null!=e&&null!=t&&null!=n){var r=n.getBoundingClientRect(),o=e.getBoundingClientRect();t.style.opacity="1";var l=t.getBoundingClientRect(),c=o.right+5;if(c+l.width>window.innerWidth||c+l.width>r.right)c=((i=o.left-l.width-5)<0?5:i)+window.pageXOffset;t.style.left="".concat(c+window.pageXOffset,"px");var i,a=o.top;if(a+l.height>window.innerHeight)a=((i=o.bottom-l.height)<0?5:i)+window.pageYOffset;t.style.top="".concat(a+ +window.pageYOffset,"px")}}),[H,P,A]),o((function(){function e(e){null==P.current||null==H.current||P.current.contains(e.target)||H.current.contains(e.target)||D(!1)}return window.addEventListener("click",e),function(){return window.removeEventListener("click",e)}}),[D,H]);var ue=r((function(){A.update((function(){if(q.isAttached()){var e=s(q),t=A.getElementByKey(e.getKey());if(!t)throw new Error("Expected to find tableElement in DOM");var n=f(t);null!==n&&n.$clearHighlight(),e.markDirty(),G(q.getLatest())}R().selectStart()}))}),[A,q]),se=function(){A.update((function(){var e=b();if(u(e)){for(var t=Y(e),n=t.columns,r=t.rows,o=e.getNodes(),l=null,c=0;c<o.length;c++){var a=o[c];if(v(a))if(null===l){a.setColSpan(n).setRowSpan(r),l=a;var s=void 0;F(a)&&N(s=a.getFirstChild())&&s.remove()}else if(v(l)){F(a)||l.append.apply(l,a.getChildren()),a.remove()}}null!==l&&(0===l.getChildrenSize()&&l.append(O()),function(e){var t=e.getLastDescendant();M(t)?t.select():k(t)?t.selectEnd():null!==t&&t.selectNext()}(l)),i()}}))},fe=r((function(e){A.update((function(){m(e),i()}))}),[A,i]),me=r((function(e){A.update((function(){for(var t=0;t<Q.columns;t++)d(e);i()}))}),[A,i,Q.columns]),de=r((function(){A.update((function(){g(),i()}))}),[A,i]),ge=r((function(){A.update((function(){s(q).remove(),ue(),i()}))}),[A,q,ue,i]),pe=r((function(){A.update((function(){p(),i()}))}),[A,i]),he=r((function(){A.update((function(){var e=s(q),t=h(q),n=e.getChildren();if(t>=n.length||t<0)throw new Error("Expected table cell to be inside of table row.");var r=n[t];if(!w(r))throw new Error("Expected table row");var o=q.getHeaderStyles()^E.ROW;r.getChildren().forEach((function(e){if(!v(e))throw new Error("Expected table cell");e.setHeaderStyles(o,E.ROW)})),ue(),i()}))}),[A,q,ue,i]),we=r((function(){A.update((function(){var e=s(q),t=C(q),n=e.getChildren();if(t>=Math.max.apply(Math,n.map((function(e){return e.getChildren().length})))||t<0)throw new Error("Expected table cell to be inside of table row.");for(var r=q.getHeaderStyles()^E.COLUMN,o=0;o<n.length;o++){var l=n[o];if(!w(l))throw new Error("Expected table row");var c=l.getChildren();if(!(t>=c.length)){var a=c[t];if(!v(a))throw new Error("Expected table cell");a.setHeaderStyles(r,E.COLUMN)}}ue(),i()}))}),[A,q,ue,i]),Ee=r((function(){A.update((function(){if(q.isAttached()){var e=s(q);e&&e.setRowStriping(!e.getRowStriping())}ue(),i()}))}),[A,q,ue,i]),ve=r((function(e){A.update((function(){var t=b();if(x(t)||u(t)){var n=S(t.anchor)[0];if(v(n)&&n.setBackgroundColor(e),u(t))for(var r=t.getNodes(),o=0;o<r.length;o++){var l=r[o];v(l)&&l.setBackgroundColor(e)}}}))}),[A]),Ce=null;return U&&(te?Ce=e.createElement(I,{onSelect:function(){return se()}},"Merge cells"):oe&&(Ce=e.createElement(I,{onSelect:function(){A.update((function(){y()}))}},"Unmerge cells"))),e.createElement(e.Fragment,null,Z,e.createElement(L,null,e.createElement(j,null,e.createElement(_,null,Ce,e.createElement(I,{className:"flex justify-between"},"Background color",e.createElement(z,{color:ie,onChange:ve,icon:e.createElement(X,{className:"size-4"})})),e.createElement(I,{onSelect:function(){return Ee()}},"Toggle row striping"),e.createElement(K,null),e.createElement(I,{onSelect:function(){return fe(!1)}},"Insert"," ",1===Q.rows?"row":"".concat(Q.rows," rows")," ","above"),e.createElement(I,{onSelect:function(){return fe(!0)}},"Insert"," ",1===Q.rows?"row":"".concat(Q.rows," rows")," ","below"),e.createElement(K,null),e.createElement(I,{onSelect:function(){return me(!1)}},"Insert"," ",1===Q.columns?"column":"".concat(Q.columns," columns")," ","left"),e.createElement(I,{onSelect:function(){return me(!0)}},"Insert"," ",1===Q.columns?"column":"".concat(Q.columns," columns")," ","right"),e.createElement(K,null),e.createElement(I,{onSelect:function(){return pe()}},"Delete column"),e.createElement(I,{onSelect:function(){return de()}},"Delete row"),e.createElement(I,{onSelect:function(){return ge()}},"Delete table"),e.createElement(K,null),e.createElement(I,{onSelect:function(){return he()}},(q.__headerState&E.ROW)===E.ROW?"Remove":"Add"," ","row header"),e.createElement(I,{onSelect:function(){return we()}},(q.__headerState&E.COLUMN)===E.COLUMN?"Remove":"Add"," ","column header")))))}function $(c){var a=c.anchorElem,u=c.cellMerge,s=l()[0],f=t(null),m=t(null),d=n(!1),g=d[0],p=d[1],h=n(null),w=h[0],E=h[1],v=r((function(){var e=f.current,t=b(),n=window.getSelection(),r=document.activeElement;if(null!=t&&null!=e){var o=s.getRootElement();if(x(t)&&null!==o&&null!==n&&o.contains(n.anchorNode)){var l=i(t.anchor.getNode());if(null==l)return void E(null);if(null==s.getElementByKey(l.getKey()))return void E(null);E(l)}else r||E(null)}else E(null)}),[s]);o((function(){return s.registerUpdateListener((function(){s.getEditorState().read((function(){v()}))}))})),o((function(){var e=f.current;if(null!=e&&null!=w){var t=s.getElementByKey(w.getKey());if(null!=t){var n=t.getBoundingClientRect(),r=e.getBoundingClientRect(),o=a.getBoundingClientRect(),l=n.top-o.top+4,c=n.right-r.width-10-o.left;e.style.opacity="1",e.style.transform="translate(".concat(c,"px, ").concat(l,"px)")}else e.style.opacity="0",e.style.transform="translate(-10000px, -10000px)"}}),[f,w,s,a]);var C=t(w);return o((function(){C.current!==w&&p(!1),C.current=w}),[C,w]),e.createElement("div",{className:"table-cell-action-button-container absolute top-0 will-change-transform",ref:f},null!=w&&e.createElement(D,{open:g,onOpenChange:p},e.createElement(H,{asChild:!0},e.createElement("button",{type:"button",className:"relative inline-block flex cursor-pointer items-center justify-center bg-none",onClick:function(e){e.stopPropagation(),p(!g)},ref:m},e.createElement(A,{className:"h-4 w-4"}))),e.createElement(U,{className:"w-[200px] p-0"},e.createElement(P,{contextRef:m,setIsMenuOpen:p,onClose:function(){return p(!1)},tableCellNode:w,cellMerge:u}))))}function q(t){var n=t.anchorElem,r=t.cellMerge,o=void 0!==r&&r,l=c();return n?B(l?e.createElement($,{anchorElem:n,cellMerge:o}):null,n):null}export{q as TableActionMenuPlugin};
//# sourceMappingURL=table-action-menu-plugin.js.map
