import{__awaiter as e,__generator as t}from"../../../../node_modules/tslib/tslib.es6.mjs.js";import*as a from"react";import{useEffect as r,useRef as n,useState as l}from"react";import{useLexicalComposerContext as o}from"../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{mergeRegister as i,$wrapNodeInElement as s}from"@lexical/utils";import{createCommand as c,$insertNodes as u,$isRootOrShadowRoot as m,$createParagraphNode as d,COMMAND_PRIORITY_EDITOR as g,DRAGSTART_COMMAND as p,COMMAND_PRIORITY_HIGH as f,DRAGOVER_COMMAND as v,COMMAND_PRIORITY_LOW as h,DROP_COMMAND as E,$createRangeSelection as A,$setSelection as w,$getSelection as x,$isNodeSelection as C}from"lexical";import{Button as y}from"../../ui/button.js";import{DialogFooter as b}from"../../ui/dialog.js";import{Input as N}from"../../ui/input.js";import{Label as _}from"../../ui/label.js";import{Tabs as D,TabsList as I,TabsTrigger as U,TabsContent as j}from"../../ui/tabs.js";import{ImageNode as T,$createImageNode as R,$isImageNode as k}from"../nodes/image-node.js";import{CAN_USE_DOM as P}from"../shared/can-use-dom.js";var F=c("INSERT_IMAGE_COMMAND");function L(a){return e(this,void 0,void 0,(function(){var e,r,n;return t(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),(e=new FormData).append("image",a),[4,fetch("/api/upload-image",{method:"POST",body:e})];case 1:if(!(r=t.sent()).ok)throw new Error("Upload failed with status: ".concat(r.status));return[4,r.json()];case 2:return[2,t.sent().imageUrl];case 3:throw n=t.sent(),console.error("Error uploading image:",n),n;case 4:return[2]}}))}))}function O(e){var t=e.onClick,r=l(""),n=r[0],o=r[1],i=l(""),s=i[0],c=i[1],u=""===n;return a.createElement("div",{className:"grid gap-4 py-4"},a.createElement("div",{className:"grid gap-2"},a.createElement(_,{htmlFor:"image-url"},"Image URL"),a.createElement(N,{id:"image-url",placeholder:"i.e. https://source.unsplash.com/random",onChange:function(e){return o(e.target.value)},value:n,"data-test-id":"image-modal-url-input"})),a.createElement("div",{className:"grid gap-2"},a.createElement(_,{htmlFor:"alt-text"},"Alt Text"),a.createElement(N,{id:"alt-text",placeholder:"Random unsplash image",onChange:function(e){return c(e.target.value)},value:s,"data-test-id":"image-modal-alt-text-input"})),a.createElement(b,null,a.createElement(y,{type:"submit",disabled:u,onClick:function(){return t({altText:s,src:n})},"data-test-id":"image-modal-confirm-btn"},"Confirm")))}function M(r){var n=this,i=r.onClick,s=r.onClose,c=r.onImageUpload;o()[0];var u=l("");u[0];var m=u[1],d=l(""),g=d[0],p=d[1],f=l(!1),v=f[0],h=f[1],E=l(null),A=E[0],w=E[1],x=l(null),C=x[0],D=x[1],I=l(""),U=I[0],j=I[1],T=!A||v;return a.createElement("div",{className:"grid gap-4 py-4"},a.createElement("div",{className:"grid gap-2"},a.createElement(_,{htmlFor:"image-upload"},"Image Upload"),a.createElement(N,{id:"image-upload",type:"file",onChange:function(e){return function(e){if(e&&e.length>0){w(e[0]),D(null);var t=new FileReader;if(t.onload=function(){"string"==typeof t.result&&j(t.result)},t.readAsDataURL(e[0]),!g){var a=e[0].name.split(".").slice(0,-1).join(".").replace(/[-_]/g," ");p(a)}}}(e.target.files)},accept:"image/*","data-test-id":"image-modal-file-upload"})),U&&a.createElement("div",{className:"grid place-items-center"},a.createElement("img",{src:U,alt:"Preview",className:"max-h-48 max-w-full object-contain rounded-md border border-gray-200"})),a.createElement("div",{className:"grid gap-2"},a.createElement(_,{htmlFor:"alt-text"},"Alt Text"),a.createElement(N,{id:"alt-text",placeholder:"Descriptive alternative text",onChange:function(e){return p(e.target.value)},value:g,"data-test-id":"image-modal-alt-text-input"})),C&&a.createElement("div",{className:"text-red-500 text-sm p-2 bg-red-50 rounded"},C),a.createElement(b,null,a.createElement(y,{type:"submit",disabled:T,onClick:function(){return e(n,void 0,void 0,(function(){var e,a,r,n,l;return t(this,(function(t){switch(t.label){case 0:if(!A)return[2];h(!0),D(null),t.label=1;case 1:if(t.trys.push([1,9,10,11]),console.log(c),c)return[3,6];t.label=2;case 2:return t.trys.push([2,4,,5]),[4,L(A)];case 3:return e=t.sent(),m(e),i({altText:g,src:e}),s&&s(),[3,5];case 4:return a=t.sent(),D("Failed to upload image using default handler. Please try again or use URL option."),console.error("Default upload error:",a),[3,5];case 5:return[3,8];case 6:return[4,c(A)];case 7:r=t.sent(),n=r.url,m(n),i({altText:g,src:n}),s&&s(),t.label=8;case 8:return[3,11];case 9:return l=t.sent(),D(l instanceof Error?l.message:"Failed to upload image to server. Please try again."),console.error("Upload error:",l),[3,11];case 10:return h(!1),[7];case 11:return[2]}}))}))},"data-test-id":"image-modal-file-upload-btn"},v?a.createElement("span",{className:"flex items-center gap-2"},a.createElement("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},a.createElement("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.createElement("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})),"Uploading..."):"Upload & Insert")))}function B(e){var t=e.activeEditor,l=e.onClose,o=e.onImageUpload,i=n(!1);console.log("onImageUpload",o),r((function(){i.current=!1;var e=function(e){i.current=e.altKey};return document.addEventListener("keydown",e),function(){document.removeEventListener("keydown",e)}}),[t]);var s=function(e){t.dispatchCommand(F,e),l()};return a.createElement(D,{defaultValue:"url"},a.createElement(I,{className:"w-full"},a.createElement(U,{value:"url",className:"w-full"},"URL"),a.createElement(U,{value:"file",className:"w-full"},"File")),a.createElement(j,{value:"url"},a.createElement(O,{onClick:s})),a.createElement(j,{value:"file"},a.createElement(M,{onClick:s,onClose:l,onImageUpload:o})))}function S(e){var t=e.captionsEnabled,a=o()[0];return r((function(){if(!a.hasNodes([T]))throw new Error("ImagesPlugin: ImageNode not registered on editor");return i(a.registerCommand(F,(function(e){var t=R(e);return u([t]),m(t.getParentOrThrow())&&s(t,d).selectEnd(),!0}),g),a.registerCommand(p,(function(e){return function(e){var t=V();if(!t)return!1;var a=e.dataTransfer;if(!a)return!1;var r="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",n=document.createElement("img");return n.src=r,a.setData("text/plain","_"),a.setDragImage(n,0,0),a.setData("application/x-lexical-drag",JSON.stringify({data:{altText:t.__altText,caption:t.__caption,height:t.__height,key:t.getKey(),maxWidth:t.__maxWidth,showCaption:t.__showCaption,src:t.__src,width:t.__width},type:"image"})),!0}(e)}),f),a.registerCommand(v,(function(e){return function(e){if(!V())return!1;G(e)||e.preventDefault();return!0}(e)}),h),a.registerCommand(E,(function(e){return function(e,t){var a=V();if(!a)return!1;var r=function(e){var t,a=null===(t=e.dataTransfer)||void 0===t?void 0:t.getData("application/x-lexical-drag");if(!a)return null;var r=JSON.parse(a),n=r.type,l=r.data;if("image"!==n)return null;return l}(e);if(!r)return!1;if(e.preventDefault(),G(e)){var n=function(e){var t,a=e.target,r=null==a?null:9===a.nodeType?a.defaultView:a.ownerDocument.defaultView,n=function(e){return P?(e||window).getSelection():null}(r);if(document.caretRangeFromPoint)t=document.caretRangeFromPoint(e.clientX,e.clientY);else{if(!e.rangeParent||null===n)throw Error("Cannot get the selection when dragging");n.collapse(e.rangeParent,e.rangeOffset||0),t=n.getRangeAt(0)}return t}(e);a.remove();var l=A();null!=n&&l.applyDOMRange(n),w(l),t.dispatchCommand(F,r)}return!0}(e,a)}),f))}),[t,a]),null}function V(){var e=x();if(!C(e))return null;var t=e.getNodes()[0];return k(t)?t:null}function G(e){var t=e.target;return!!(t&&t instanceof HTMLElement&&!t.closest("code, span.editor-image")&&t.parentElement&&t.parentElement.closest("div.ContentEditable__root"))}c("UPLOAD_IMAGE_COMMAND");export{F as INSERT_IMAGE_COMMAND,S as ImagesPlugin,B as InsertImageDialog,M as InsertImageUploadedDialogBody,O as InsertImageUriDialogBody};
//# sourceMappingURL=images-plugin.js.map
