import{__extends as n,__spreadArray as e}from"../../../../../node_modules/tslib/tslib.es6.mjs.js";import{useLexicalComposerContext as t}from"../../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{mergeRegister as o}from"@lexical/utils";import{$createTextNode as r,KEY_ARROW_DOWN_COMMAND as l,COMMAND_PRIORITY_LOW as i,KEY_ARROW_UP_COMMAND as u,KEY_ENTER_COMMAND as a,COMMAND_PRIORITY_NORMAL as c,KEY_TAB_COMMAND as m,KEY_BACKSPACE_COMMAND as s,KEY_DOWN_COMMAND as f,FOCUS_COMMAND as d,CLICK_COMMAND as v,KEY_ESCAPE_COMMAND as p,$getSelection as g,$isRangeSelection as b}from"lexical";import{useState as h,useMemo as x,useCallback as y,useEffect as C}from"react";import*as I from"react-dom";import{MenuOption as S,$splitNodeContainingQuery as E}from"./Menu.js";import{IS_MOBILE as w,CAN_USE_DOM as O}from"./environment.js";import{$insertTriggerAtSelection as j}from"./mention-commands.js";import{getTextContent as R}from"./mention-utils.js";import{useIsFocused as T}from"./useIsFocused.js";var V=function(e){function t(n,t,o,r){void 0===r&&(r={});var l=e.call(this,t,o,r)||this;return l.itemType=n,l.comboboxItem={itemType:n,value:t,displayValue:o,data:r},l.menuOption=new S(t,o,r),l}return n(t,e),t}(S);function k(n){var e=null;return n.getEditorState().read((function(){var n=g();b(n)&&(e=function(n){var e=n.anchor;if("text"!==e.type)return null;var t=e.getNode();if(!t.isSimpleText())return null;var o=e.offset;return R(t).slice(0,o)}(n))})),e}function L(n,e,o){var r=t()[0],l=h(null!=e?e:null),i=l[0],u=l[1],a=h(null),c=a[0],m=a[1];return C((function(){if(!e)return r.registerRootListener((function(n){n&&u(n.parentElement)}));u(e)}),[r,e]),C((function(){if(i){if(n){var e=i.getBoundingClientRect().height,t=null!=c?c:document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.right="0",t.style.paddingTop="".concat(e,"px"),i.prepend(t),c||m(t);var r=new ResizeObserver((function(n){var e=n[0];t.style.paddingTop="".concat(e.contentRect.height,"px")}));return r.observe(i),setTimeout((function(){t.className=null!=o?o:""})),function(){r.disconnect(),i.removeChild(t)}}c&&(c.remove(),m(null))}}),[i,n,c,o]),c}function D(n,e){var t,o=null!==(t=n.split(/\s/).pop())&&void 0!==t?t:n,r=n!==o?n.lastIndexOf(o):0;return e.some((function(n){return n.startsWith(o)&&n!==o}))?{leadOffset:r,matchingString:o,replaceableString:o}:null}function M(n){var g,b=n.onSelectOption,S=n.triggers,R=n.punctuation,M=n.autoSpace,W=n.loading,A=n.triggerFn,F=n.onQueryChange,K=n.onReset,N=n.comboboxAnchor,P=n.comboboxAnchorClassName,_=n.comboboxComponent,z=void 0===_?"div":_,B=n.comboboxItemComponent,Q=void 0===B?"div":B,U=n.onComboboxOpen,q=n.onComboboxClose,G=n.onComboboxFocusChange,H=n.comboboxAdditionalItems,J=void 0===H?[]:H,X=n.onComboboxItemSelect,Y=T(),Z=t()[0],$=h(null),nn=$[0],en=$[1],tn=h(null),on=tn[0],rn=tn[1],ln=h(null),un=ln[0],an=ln[1],cn=h(null),mn=cn[0],sn=cn[1],fn=0===n.options.length?"trigger":"value",dn=x((function(){var t=J.map((function(n){return new V("additional",n.value,n.displayValue,n.data)}));if("trigger"===fn){var o=S.map((function(n){return new V("trigger",n,n)}));return!mn||o.every((function(n){return!n.value.startsWith(mn)}))?e(e([],o,!0),t,!0):e(e([],o.filter((function(n){return n.value.startsWith(mn)})),!0),t,!0)}return e(e([],n.options.map((function(n){return new V("value",n.value,n.displayValue,n.data)})),!0),t,!0)}),[J,fn,n.options,S,mn]),vn=h(null!==(g=n.comboboxOpen)&&void 0!==g&&g),pn=vn[0],gn=vn[1],bn=L(pn,N,P),hn=y((function(n){w||en(n)}),[]),xn=y((function(n){var e,t=null===(e=dn[n].ref)||void 0===e?void 0:e.current;t&&t.scrollIntoView({block:"nearest"})}),[dn]),yn=y((function(n,e){return!!Y&&(t="up"===e?null===nn?dn.length-1:0===nn?null:nn-1:null===nn?0:nn===dn.length-1?null:nn+1,hn(t),t&&xn(t),n.preventDefault(),n.stopImmediatePropagation(),!0);var t}),[Y,nn,dn.length,xn,hn]),Cn=y((function(n){hn(n),xn(n)}),[xn,hn]),In=y((function(){hn(null)}),[hn]),Sn=y((function(n){var e=dn[n];null==X||X(e.comboboxItem),"additional"!==e.itemType&&(Z.update((function(){var n=un?E(un):null;b(e.menuOption,n)})),an(null),F(null),sn(null),hn(null))}),[dn,Z,F,hn,X,un,b]),En=y((function(n){var e=dn[n];null==X||X(e.comboboxItem),"additional"!==e.itemType&&(Z.update((function(){var n=on?E(on):null;if(n){var t=r(e.value);n.replace(t),t.select()}else j(S,R,e.value,M)})),rn(null),sn(null),hn(0))}),[dn,Z,hn,X,on,S,R,M]),wn=y((function(n){"trigger"===fn&&En(n),"value"===fn&&Sn(n)}),[fn,En,Sn]),On=y((function(n){if(!Y||null===nn)return!1;var e=!1;return"trigger"===fn&&(e=!0,En(nn)),"value"===fn&&(e=!0,Sn(nn)),e&&(n.preventDefault(),n.stopImmediatePropagation()),e}),[Y,Sn,En,fn,nn]),jn=y((function(){var n=k(Z),e=n?n.substring(0,n.length-1):void 0;return(null==e?void 0:e.trim())||hn(null),!1}),[Z,hn]),Rn=y((function(n){if(gn(!0),!function(n){return!(1!==n.key.length||n.ctrlKey||n.altKey||n.metaKey||n.repeat)}(n))return!1;var e=k(Z),t=(null===e?n.key:e+n.key).trim();return dn.some((function(n){return n.displayValue.startsWith(t)&&t.length<=n.displayValue.length}))?hn(0):"trigger"===fn&&hn(null),!1}),[Z,dn,fn,hn]),Tn=y((function(){return gn(!0),!1}),[]),Vn=y((function(){return gn(!1),mn||(sn(null),rn(null),an(null)),!1}),[mn]);return C((function(){return o(Z.registerCommand(l,(function(n){return yn(n,"down")}),i),Z.registerCommand(u,(function(n){return yn(n,"up")}),i),Z.registerCommand(a,On,c),Z.registerCommand(m,On,i),Z.registerCommand(s,jn,i),Z.registerCommand(f,Rn,i),Z.registerCommand(d,Tn,c),Z.registerCommand(v,(function(){return pn||gn(!0),!1}),i),Z.registerCommand(p,(function(){return gn(!1),!1}),i))}),[Z,pn,yn,On,jn,Rn,Tn]),C((function(){return Z.registerUpdateListener((function(){Z.getEditorState().read((function(){var n=k(Z);if(null===n)return K(),rn(null),an(null),F(null),void sn(null);var e=D(n,S);if(rn(e),e)return sn(e.matchingString),void an(null);var t=A(n,Z);an(t),F(t?t.matchingString:null),(null==t?void 0:t.matchingString)?sn(t.matchingString):sn(null)}))}))}),[Z,A,F,K,S]),C((function(){var e;gn(null!==(e=n.comboboxOpen)&&void 0!==e&&e)}),[n.comboboxOpen]),C((function(){pn?null==U||U():(en(null),null==q||q())}),[U,q,pn]),C((function(){null!==nn&&dn[nn]?null==G||G(dn[nn].comboboxItem):null==G||G(null)}),[nn,dn,G]),C((function(){if(O){var n=Z.getRootElement(),e=function(e){bn&&!bn.contains(e.target)&&n&&!n.contains(e.target)&&Vn()};return document.addEventListener("mousedown",e),function(){document.removeEventListener("mousedown",e)}}}),[bn,Z,Vn]),pn&&bn?I.createPortal(React.createElement(z,{loading:W,itemType:fn,role:"menu","aria-activedescendant":null!==nn&&dn[nn]?dn[nn].displayValue:"","aria-label":"Choose trigger and value","aria-hidden":!pn},dn.map((function(n,e){return React.createElement(Q,{key:n.key,selected:e===nn,role:"menuitem","aria-selected":nn===e,"aria-label":"Choose ".concat(n.value),item:n.comboboxItem,ref:n.setRefElement,onClick:function(){wn(e)},onMouseEnter:function(){Cn(e)},onMouseLeave:In,onMouseDown:function(n){n.preventDefault()}},n.displayValue)}))),bn):null}export{M as ComboboxPlugin,D as checkForTriggers,L as useAnchorRef};
//# sourceMappingURL=ComboboxPlugin.js.map
