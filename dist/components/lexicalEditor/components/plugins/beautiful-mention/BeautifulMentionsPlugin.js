import{__extends as e,__rest as n,__assign as t}from"../../../../../node_modules/tslib/tslib.es6.mjs.js";import{useLexicalComposerContext as r}from"../../../../../node_modules/@lexical/react/LexicalComposerContext.mjs.js";import{LexicalTypeaheadMenuPlugin as o}from"../../../../../node_modules/@lexical/react/LexicalTypeaheadMenuPlugin.mjs.js";import{mergeRegister as i}from"@lexical/utils";import{TextNode as a,$createTextNode as u,$isParagraphNode as l,$getSelection as s,$setSelection as c,$isNodeSelection as m,SELECTION_CHANGE_COMMAND as f,COMMAND_PRIORITY_LOW as d,KEY_DOWN_COMMAND as g,KEY_BACKSPACE_COMMAND as v,BLUR_COMMAND as p,KEY_SPACE_COMMAND as b,PASTE_COMMAND as C,COMMAND_PRIORITY_NORMAL as x}from"lexical";import{useRef as h,useMemo as y,useState as S,useCallback as A,useEffect as N}from"react";import*as j from"react-dom";import{ComboboxPlugin as I}from"./ComboboxPlugin.js";import{$createBeautifulMentionNode as O,$isBeautifulMentionNode as w,BeautifulMentionNode as E}from"./MentionNode.js";import{MenuOption as M}from"./Menu.js";import{CAN_USE_DOM as V,IS_MOBILE as R}from"./environment.js";import{INSERT_MENTION_COMMAND as T,$insertMentionAtSelection as D,REMOVE_MENTIONS_COMMAND as k,$removeMention as F,RENAME_MENTIONS_COMMAND as P,$renameMention as B,OPEN_MENTION_MENU_COMMAND as L,$insertTriggerAtSelection as $}from"./mention-commands.js";import{getCreatableProp as _,getMenuItemLimitProp as q,$findBeautifulMentionNodes as K,$getSelectionInfo as Q,getTextContent as H,$selectEnd as U,isWordChar as W,DEFAULT_PUNCTUATION as z,PRE_TRIGGER_CHARS as G,TRIGGERS as J,VALID_CHARS as X,LENGTH_LIMIT as Y}from"./mention-utils.js";import{useIsFocused as Z}from"./useIsFocused.js";import{useMentionLookupService as ee}from"./useMentionLookupService.js";var ne=function(n){function t(e,t,r,o){var i=n.call(this,t,r,o)||this;return i.trigger=e,i.menuItem={trigger:e,value:t,displayValue:r,data:o},i}return e(t,n),t}(M);function te(e,n,t,r,o){var i=function(e,n,t,r){return new RegExp((n?"(^|\\s|".concat(n,")("):"(^|\\s)(")+J(e)+"((?:"+X(e,t)+(r?function(e){return"(?:\\.[ |$]|\\s|["+e+"]|)"}(t):"")+"){0,"+Y+"}))$")}(n,t,r,o).exec(e);if(null!==i){var a=i[1],u=i[2],l=i[3];if(u.length>=1)return{leadOffset:i.index+a.length,matchingString:l,replaceableString:u}}return null}function re(e){var M=e.items,J=e.onSearch,X=e.autoSpace,Y=void 0===X||X,re=e.searchDelay,oe=void 0===re?e.onSearch?250:0:re,ie=e.allowSpaces,ae=void 0===ie||ie,ue=e.insertOnBlur,le=void 0===ue||ue,se=e.menuComponent,ce=void 0===se?"ul":se,me=e.menuItemComponent,fe=void 0===me?"li":me,de=e.emptyComponent,ge=e.menuAnchorClassName,ve=e.showMentionsOnDelete,pe=e.showCurrentMentionsAsSuggestions,be=void 0===pe||pe,Ce=e.mentionEnclosure,xe=e.onMenuOpen,he=e.onMenuClose,ye=e.onMenuItemSelect,Se=e.punctuation,Ae=void 0===Se?z:Se,Ne=e.preTriggerChars,je=void 0===Ne?G:Ne,Ie=h(!1),Oe=Z(),we=y((function(){var n;return null!==(n=e.triggers)&&void 0!==n?n:Object.keys(null!=M?M:{})}),[e.triggers,M]),Ee=r()[0],Me=S(null),Ve=Me[0],Re=Me[1],Te=S(null),De=Te[0],ke=Te[1],Fe=ee({queryString:Ve,searchDelay:oe,trigger:De,items:M,onSearch:J,justSelectedAnOption:Ie}),Pe=Fe.results,Be=Fe.loading,Le=Fe.query,$e=h(null),_e=h(null),qe=_(e.creatable,De),Ke=q(e.menuItemLimit,De),Qe=y((function(){if(!De)return[];var e=Pe.map((function(e){if("string"==typeof e)return new ne(De,e,e);var t=e.value,r=n(e,["value"]);return new ne(De,t,t,r)}));if(!1!==Ke&&Ke>0&&(e=e.slice(0,Ke)),(!J||!Be&&null!==Le)&&be&&Ee.getEditorState().read((function(){for(var n=function(n){var t=n.getValue(),r=n.getData();n.getTrigger()===De&&(null===Le||n.getValue().startsWith(Le))&&e.every((function(e){return e.value!==t}))&&e.push(new ne(De,t,t,r))},t=0,r=K(Ee);t<r.length;t++){n(r[t])}})),Le&&e.every((function(e){return e.displayValue!==Le}))){var t="string"==typeof qe?qe.replace("{{name}}",Le):void 0===qe||qe?'Add "'.concat(Le,'"'):void 0;t&&e.push(new ne(De,Le,t))}return e}),[Pe,J,Be,Le,Ee,De,qe,Ke,be]),He=!!J&&!Qe.length&&!!Ve&&/\s+/.test(Ve),Ue=!!Qe.length||Be&&!He,We=A((function(){ke(null)}),[]),ze=A((function(e,n,t){Ee.update((function(){if(De){var r=!!qe&&e.value!==e.displayValue&&Ce&&/\s/.test(e.value)?Ce+e.value+Ce:e.value,o=O(De,r,e.data);if(n){var i=n.getNextSibling();if(n.replace(o),i instanceof a){var u=i.getTextContent();!/\s/.test(u)&&r.includes(u)&&i.remove()}}null==t||t(),Ie.current=!0}}))}),[Ee,De,qe,Ce]),Ge=A((function(e,n,t){De&&(null==ye||ye({trigger:De,value:e.value,displayValue:e.displayValue,data:e.data}),ze(e,n,t))}),[ze,ye,De]),Je=A((function(e){var n=te(e,we,je,Ae,ae);if(n){var t=n.replaceableString,r=n.matchingString,o=t.lastIndexOf(r),i=-1===o?t:t.substring(0,o)+t.substring(o+r.length);if(ke(i||null),n.replaceableString)return n}else ke(null);return null}),[je,ae,Ae,we]),Xe=A((function(e){if(void 0===e&&(e=!1),Y){var n=Q(we,Ae);if(n){var t=n.node,r=n.offset,o=n.type,i=n.parentNode,a=n.isTextNode,s=n.textContent,c=n.prevNode,m=n.nextNode,f=n.wordCharAfterCursor,d=n.cursorAtStartOfNode,g=n.cursorAtEndOfNode;if(a&&d&&w(c))t.insertBefore(u(" "));else{if(w(t)&&null===c&&l(i)&&"element"===o&&0===r){var v=u(" ");return t.insertBefore(v),void v.selectStart()}if(a&&g&&w(m))t.insertAfter(u(" "));else if(a&&e&&f){var p=s.substring(0,r)+" "+s.substring(r);t.setTextContent(p)}else w(t)&&null===m&&t.insertAfter(u(" "))}}}}),[Ae,we,Y]),Ye=A((function(e){void 0===e&&(e=!1);var n=$e.current,t="number"==typeof n?Qe[n]:void 0,r=Qe.find((function(e){return e.value!==e.displayValue}));if(r&&(R||null===t)&&(t=r),!t)return!1;var o=Q(we,Ae);if(!De||!(null==o?void 0:o.isTextNode))return!1;var i=o.node,a=H(i),u=te(a,we,je,Ae,ae);if(null===u)return!1;var l=a.search(new RegExp("".concat(u.replaceableString,"\\s?$")));if(-1===l)return!1;var m=O(De,t.value,t.data);if(Ee.update((function(){i.setTextContent(a.substring(0,l)),i.insertAfter(m),m.selectNext()}),{tag:"history-merge"}),e){var f=s();setTimeout((function(){Ee.update((function(){f&&c(f.clone())}))}))}return!0}),[Qe,we,Ae,De,je,ae,Ee]),Ze=A((function(){var e=s();if(e&&!m(e)||!_e.current)e||U();else{var n=_e.current.clone();c(n)}_e.current&&(_e.current=null)}),[]),en=A((function(e){if(!ve)return!1;var n=Q(we,Ae);if(n){var t=n.node,r=n.prevNode,o=n.offset,i=w(t)?t:w(r)&&0===o?r:null;if(i){var a=i.getTrigger();return i.replace(u(a)),e.preventDefault(),!0}}return!1}),[ve,we,Ae]),nn=A((function(e){var n,t=e.key,r=e.metaKey,o=e.ctrlKey,i=1===t.length,a=W(t,we,Ae),u=ae&&/^\s$/.test(t);if(!i||r||o)return!1;var l=t,s=Q(we,Ae);if(null==s?void 0:s.isTextNode){var c=s.textContent,m=s.offset,f=null!==(n=c.substring(0,m).split(/\s+/).at(-1))&&void 0!==n?n:"";l=(f+t).trim()}var d=we.some((function(e){return l===e}));return!!(a||d||u)&&(Xe(d),!1)}),[Xe,Ae,we,ae]),tn=A((function(e){var n,t=null===(n=e.clipboardData)||void 0===n?void 0:n.getData("text/plain"),r=null==t?void 0:t.charAt(0),o=we.some((function(e){return r===e})),i=r&&new RegExp("[\\s".concat(Ae,"]")).test(r);return!o&&i||Xe(),!1}),[Xe,we,Ae]);return N((function(){if(!Ee.hasNodes([E]))throw new Error("BeautifulMentionsPlugin: BeautifulMentionNode not registered on editor");return i(Ee.registerCommand(f,(function(){var e=s();return e&&!m(e)?_e.current=e:e||(_e.current=null),!1}),d),Ee.registerCommand(g,nn,d),Ee.registerCommand(v,en,d),Ee.registerCommand(p,(function(){return!!le&&Ye(!0)}),d),Ee.registerCommand(b,(function(){return!(ae||!qe)&&Ye()}),d),Ee.registerCommand(T,(function(e){var n=e.trigger,t=e.value,r=e.data,o=e.focus,i=void 0===o||o;Ze();var a=D(we,Ae,n,t,r,Y);return i||c(null),a}),d),Ee.registerCommand(k,(function(e){var n=e.trigger,t=e.value,r=e.focus,o=F(n,t,r);return r||(_e.current=null),o}),d),Ee.registerCommand(P,(function(e){var n=e.trigger,t=e.newValue,r=e.value,o=e.focus;return B(n,t,r,o)}),d),Ee.registerCommand(L,(function(e){var n=e.trigger;return Ze(),$(we,Ae,n,Y)}),d),Ee.registerCommand(C,tn,d))}),[Ee,we,Ae,Y,ae,le,qe,Oe,Ye,nn,en,tn,Ze]),N((function(){Ue&&Oe?null==xe||xe():null==he||he(),Ue&&!Oe&&We()}),[xe,he,Ue,Oe,We]),V?e.combobox?React.createElement(I,{options:Qe,loading:Be,onQueryChange:Re,onSelectOption:ze,onReset:function(){ke(null)},triggerFn:Je,triggers:we,punctuation:Ae,creatable:qe,comboboxOpen:e.comboboxOpen,comboboxAnchor:e.comboboxAnchor,comboboxAnchorClassName:e.comboboxAnchorClassName,comboboxComponent:e.comboboxComponent,comboboxItemComponent:e.comboboxItemComponent,comboboxAdditionalItems:e.comboboxAdditionalItems,onComboboxOpen:e.onComboboxOpen,onComboboxClose:e.onComboboxClose,onComboboxFocusChange:e.onComboboxFocusChange,onComboboxItemSelect:e.onComboboxItemSelect}):React.createElement(o,{commandPriority:x,onQueryChange:Re,onSelectOption:Ge,triggerFn:Je,options:Qe,anchorClassName:ge,onClose:We,menuRenderFn:function(e,n){var r=n.selectedIndex,o=n.selectOptionAndCleanUp,i=n.setHighlightedIndex;return $e.current=r,e.current&&0===Qe.length&&Le&&!Be&&Oe&&de?j.createPortal(React.createElement(de,null),e.current):e.current&&Ue?j.createPortal(React.createElement(ce,{loading:Be,role:"menu","aria-label":"Choose a mention","aria-hidden":!Ue,"aria-activedescendant":!R&&null!==r&&Qe[r]?Qe[r].displayValue:""},Qe.map((function(e,n){return React.createElement(fe,t({key:e.key,tabIndex:-1,selected:!R&&r===n,ref:e.setRefElement,role:"menuitem","aria-selected":!R&&r===n,"aria-label":"Choose ".concat(e.value),item:e.menuItem,itemValue:e.value,label:e.displayValue},e.data,{onClick:function(){i(n),o(e)},onMouseDown:function(e){e.preventDefault()},onMouseEnter:function(){i(n)}}),e.displayValue)}))),e.current):null}}):null}export{re as BeautifulMentionsPlugin,te as checkForMentions};
//# sourceMappingURL=BeautifulMentionsPlugin.js.map
